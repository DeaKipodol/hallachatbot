# 한라챗봇 핵심 클래스 및 함수

이 문서는 한라챗봇 프로젝트의 핵심 클래스와 함수들을 설명합니다.

> **최근 업데이트** (2025-10-10): Phase 2 - RAG 모듈 분리 완료

---

## 📁 AI 모듈 (`/ai`)

### 1. ChatbotStream 클래스 ⭐ **통합 오케스트레이터**

**파일 위치**: `ai/chatbot/stream.py`

**주요 책임**: 챗봇의 핵심 로직을 구현한 클래스로, 대화 컨텍스트 관리, RAG 처리, 함수 호출, JSON Lines 스트리밍 응답 생성을 담당

#### 주요 메서드:

```python
def __init__(self, model: str, system_role: str, instruction: str, **kwargs)
```
- **설명**: 챗봇 인스턴스 초기화
- **매개변수**:
  - `model`: 사용할 GPT 모델 ID (예: "gpt-4o")
  - `system_role`: 시스템 역할 프롬프트
  - `instruction`: 챗봇에게 주어질 지시사항
  - `**kwargs`: 추가 설정(user, assistant 등)
- **초기화 내용**:
  - RagService 인스턴스 생성
  - FunctionCalling 인스턴스 생성
  - 메시지 히스토리 초기화

---

```python
async def stream_chat(
    self,
    question: str,
    language: Optional[str] = None,
    enable_rag: bool = True,
    enable_functions: bool = True
) -> AsyncGenerator[str, None]
```
- **설명**: 9단계 통합 스트리밍 처리 (핵심 메서드)
- **매개변수**:
  - `question`: 사용자 질문
  - `language`: 응답 언어 (한국어/영어)
  - `enable_rag`: RAG 사용 여부
  - `enable_functions`: 함수 호출 사용 여부
- **반환**: JSON Lines 형식 스트리밍 제너레이터
- **처리 단계**:
  1. 메시지 추가 및 언어 설정
  2-6. RAG 처리 (5단계 파이프라인)
  7. 함수 호출 분석/실행
  8. OpenAI API 스트리밍 호출
  9. 메타데이터 전송

---

```python
def _condense_rag_context(self, rag_result: RagResult) -> str
```
- **설명**: RAG 컨텍스트 요약 (3500 토큰 초과 시)
- **매개변수**: `rag_result` - RAG 검색 결과
- **반환**: 요약된 컨텍스트 문자열

---

```python
def _build_final_context(
    self,
    rag_context: Optional[str],
    function_result: Optional[str]
) -> str
```
- **설명**: 최종 프롬프트 구성 (RAG + 함수 결과)
- **반환**: 통합 컨텍스트 문자열

---

```python
async def _analyze_and_execute_functions(
    self,
    user_message: str
) -> Tuple[Optional[FunctionCallMetadata], Optional[str]]
```
- **설명**: 함수 호출 분석 및 실행
- **반환**: (FunctionCallMetadata, 함수 결과 문자열)

---

```python
async def _stream_openai_response(
    self,
    temp_context: Optional[str] = None
) -> AsyncGenerator[Tuple[str, str], None]
```
- **설명**: OpenAI API 스트리밍 호출
- **반환**: (chunk_type, content) 튜플 스트림
  - chunk_type: "delta" | "function_call"
  - content: 응답 텍스트

---

### 2. RagService 클래스 ⭐ **RAG 오케스트레이터**

**파일 위치**: `ai/rag/service.py`

**주요 책임**: RAG 5단계 파이프라인 오케스트레이션

#### 주요 메서드:

```python
def __init__(self)
```
- **설명**: RAG 서비스 초기화
- **초기화 내용**:
  - RegulationGate 인스턴스 생성
  - PineconeRetriever 인스턴스 생성
  - MongoChunkRepository 인스턴스 생성
  - ContextBuilder 인스턴스 생성

---

```python
def retrieve_context(self, question: str) -> RagResult
```
- **설명**: RAG 5단계 파이프라인 실행
- **매개변수**: `question` - 사용자 질문
- **반환**: `RagResult` (is_regulation, merged_documents_text, source_documents 등)
- **처리 단계**:
  1. Gate: 규정 질문 판단
  2. Retriever: Pinecone 검색
  3. Repository: MongoDB 조회
  4. Context Builder: 문서 조립
  5. Result: 최종 결과 반환

---

```python
@dataclass
class RagResult:
    is_regulation: bool
    merged_documents_text: str  # 병합된 문서 텍스트
    source_documents: List[SourceDocument]
    regulation_check_reason: str
    total_chunks: int
    pinecone_query_time_ms: int
    mongo_query_time_ms: int
    # ... 기타 메타데이터
```

---

### 3. RegulationGate 클래스

**파일 위치**: `ai/rag/gate.py`

**주요 책임**: 질문이 학사 규정 관련인지 LLM 기반 판단

#### 주요 메서드:

```python
def should_use_rag(self, question: str) -> GateDecision
```
- **설명**: 규정 질문 여부 판단
- **매개변수**: `question` - 사용자 질문
- **반환**: `GateDecision` (is_regulation: bool, reason: str)
- **판단 기준**:
  - 학사 규정 관련 질문 → True
  - 일반 대화 → False

---

### 4. PineconeRetriever 클래스

**파일 위치**: `ai/rag/retriever.py`

**주요 책임**: Pinecone 벡터 검색

#### 주요 메서드:

```python
def search(self, query: str, top_k: int = 10) -> RetrieverResult
```
- **설명**: 벡터 유사도 검색
- **매개변수**:
  - `query`: 검색 쿼리
  - `top_k`: 검색 결과 개수
- **반환**: `RetrieverResult` (hits: List[dict], chunk_ids: List[str])

---

### 5. MongoChunkRepository 클래스

**파일 위치**: `ai/rag/repository.py`

**주요 책임**: MongoDB 문서 저장소 접근

#### 주요 메서드:

```python
def find_by_ids(self, chunk_ids: List[str]) -> List[Dict[str, Any]]
```
- **설명**: chunk_id로 문서 조회
- **매개변수**: `chunk_ids` - 문서 ID 목록
- **반환**: 문서 목록 (list of dict)

---

### 6. ContextBuilder 클래스

**파일 위치**: `ai/rag/RagDocumentPackage.py`

**주요 책임**: MongoDB 문서 조립 및 메타데이터 추출

#### 주요 메서드:

```python
def build(
    self,
    documents: List[Dict[str, Any]],
    retriever_result: RetrieverResult
) -> RagDocumentPackage
```
- **설명**: 문서 조립 및 메타데이터 생성
- **매개변수**:
  - `documents`: MongoDB 문서 목록
  - `retriever_result`: Pinecone 검색 결과
- **반환**: `RagDocumentPackage`
  - `merged_documents_text`: 병합된 문서 텍스트 (`\n\n`로 연결)
  - `source_documents`: 출처 문서 목록
  - `retrieved_chunks`: 검색된 청크 수
  - `extracted_texts`: 추출된 텍스트 목록
- **Fallback**: MongoDB 조회 실패 시 Pinecone metadata.text 사용

---

### 7. FunctionCalling 클래스

**파일 위치**: `ai/functions/analyzer.py`

**주요 책임**: 함수 호출 분석 및 실행을 담당

#### 주요 메서드:

```python
def __init__(self, model: str, available_functions: Optional[Dict] = None)
```
- **설명**: 함수 호출 인스턴스 초기화
- **매개변수**:
  - `model`: 사용할 GPT 모델 ID
  - `available_functions`: 사용 가능한 함수 사전

---

```python
def analyze(
    self,
    user_message: str,
    tools: List[Dict[str, Any]]
) -> Tuple[Optional[str], Optional[str], Optional[Dict]]
```
- **설명**: 사용자 메시지 분석하여 필요한 함수 호출 판단
- **매개변수**:
  - `user_message`: 사용자 메시지
  - `tools`: 사용 가능한 함수 도구 목록
- **반환**: (함수명, 함수 결과, 함수 정보)
  - 함수가 필요 없으면 `(None, None, None)`
  - 함수 호출 시 실행 후 결과 반환

---

## 📁 메타데이터 클래스 (`/ai/chatbot`)

**파일 위치**: `ai/chatbot/metadata.py`

### 8. RagMetadata

```python
@dataclass
class RagMetadata:
    is_regulation: bool
    source_documents: List[Dict[str, Any]]
    merged_documents_text: str
    regulation_check_reason: str
    total_chunks: int
    retrieved_chunks: int
    pinecone_query_time_ms: int
    mongo_query_time_ms: int
    context_build_time_ms: int
    used_fallback: bool
    fallback_reason: Optional[str] = None
```
- **설명**: RAG 검색 메타데이터
- **용도**: 클라이언트에게 RAG 검색 정보 제공
- **포함 정보**: 출처 문서, 검색 시간, Fallback 여부 등

---

### 9. FunctionCallMetadata

```python
@dataclass
class FunctionCallMetadata:
    function_name: str
    arguments: Dict[str, Any]
    result: str
```
- **설명**: 함수 호출 메타데이터
- **용도**: 클라이언트에게 함수 호출 정보 제공

---

### 10. ChatMetadata

```python
@dataclass
class ChatMetadata:
    rag: Optional[RagMetadata] = None
    functions: Optional[FunctionCallMetadata] = None
    web_search_status: Optional[str] = None
```
- **설명**: 전체 메타데이터 통합
- **용도**: JSON Lines의 `metadata` 타입 메시지로 전송

---

## 📁 레거시 모듈 (`/chatbotDirectory`)

> **참고**: 점진적으로 `/ai` 모듈로 마이그레이션 중

### 11. 함수 구현 (functioncalling.py)

#### search_internet()
```python
def search_internet(query: str, max_results: int = 5) -> str
```
- **설명**: 웹 검색 함수
- **사용 API**: DuckDuckGo
- **반환**: 검색 결과 요약 문자열

---

#### get_halla_cafeteria_menu()
```python
def get_halla_cafeteria_menu(date: str, meal_type: str = "중식") -> str
```
- **설명**: 학식 메뉴 조회 함수
- **크롤링**: BeautifulSoup 사용
- **반환**: 메뉴 정보 문자열

---

## 📁 데이터 로딩 모듈 (`/loding`)

### 12. 문서 청킹 함수 (documentLoding.py)

#### extract_chunks_finditer()
```python
def extract_chunks_finditer(text: str, doc_num: str, file_name: str) -> List[Dict]
```
- **설명**: 조항 단위 청킹
- **정규식**: `제\d+조` 패턴 사용
- **반환**: 청크 목록 (chunk_id, text, metadata 포함)

---

#### extract_star_tables()
```python
def extract_star_tables(text: str, doc_num: str, file_name: str) -> List[Dict]
```
- **설명**: 별표 단위 청킹
- **정규식**: `\[별표 \d+\]` 패턴 사용
- **반환**: 별표 청크 목록

---

## 📁 데이터 접근 계층 (`/ai/data`)

### 13. MongoDB 클라이언트 (mongodb_client.py)

```python
from ai.data.mongodb_client import collection
```
- **설명**: MongoDB 연결 및 컬렉션 제공
- **사용**: `collection.find(...)` 형태로 사용

---

### 14. 벡터 업로더 (vector_uploader.py)

```python
def upload_to_pinecone(chunks: List[Dict], batch_size: int = 100)
```
- **설명**: Pinecone에 임베딩 업로드
- **매개변수**:
  - `chunks`: 문서 청크 목록
  - `batch_size`: 배치 크기
- **처리**: 
  - OpenAI 임베딩 생성
  - Pinecone 업로드
  - 에러 처리 및 재시도

---

## 🔧 유틸리티 함수

### 15. 토큰 카운팅 (ai/chatbot/stream.py)

```python
def _count_tokens(self, text: str) -> int
```
- **설명**: 텍스트의 토큰 수 계산
- **사용**: tiktoken 라이브러리
- **반환**: 토큰 수 (int)

---

### 16. JSON Lines 생성 (ai/chatbot/stream.py)

```python
def _format_json_line(self, type: str, **kwargs) -> str
```
- **설명**: JSON Lines 형식 메시지 생성
- **매개변수**:
  - `type`: "delta" | "metadata" | "done"
  - `**kwargs`: 추가 필드
- **반환**: JSON 문자열 + `\n`

**예시**:
```python
_format_json_line("delta", content="안녕")
# → '{"type":"delta","content":"안녕"}\n'

_format_json_line("metadata", metadata={...})
# → '{"type":"metadata","metadata":{...}}\n'
```

---

## 📋 요약

### Phase 2 주요 변경사항

1. **RAG 모듈 분리** (`/ai/rag`):
   - Service → Gate → Retriever → Repository → ContextBuilder
   - 단일 책임 원칙 적용
   - 레이어드 아키텍처

2. **스트리밍 통합** (`/ai/chatbot/stream.py`):
   - 9단계 통합 처리
   - JSON Lines 형식
   - 메타데이터 제공

3. **메타데이터 시스템** (`/ai/chatbot/metadata.py`):
   - RAG, 함수 호출 정보 제공
   - 클라이언트 투명성 증대

4. **명명 규칙 개선**:
   - `context` → `merged_documents_text` (의미 명확화)
   - `documents` → `retrieved_chunks` (역할 명확화)
   - 모든 변수명 일관성 확보

---

**관련 문서**:
- [프로젝트 구조](프로젝트_구조.md) - 전체 구조 및 폴더 설명
- [프론트엔드 API 통합 가이드](프론트엔드_API_통합_가이드.md) - JSON Lines API 사용법
- [기능 목록](기능_목록.md) - 기능별 상세 설명