# í•œë¼ì±—ë´‡ í•µì‹¬ í´ë˜ìŠ¤ ë° í•¨ìˆ˜

ì´ ë¬¸ì„œëŠ” í•œë¼ì±—ë´‡ í”„ë¡œì íŠ¸ì˜ í•µì‹¬ í´ë˜ìŠ¤ì™€ í•¨ìˆ˜ë“¤ì„ ì„¤ëª…í•©ë‹ˆë‹¤.

> **ìµœê·¼ ì—…ë°ì´íŠ¸** (2025-10-10): Phase 2 - RAG ëª¨ë“ˆ ë¶„ë¦¬ ì™„ë£Œ

---

## ğŸ“ AI ëª¨ë“ˆ (`/ai`)

### 1. ChatbotStream í´ë˜ìŠ¤ â­ **í†µí•© ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°**

**íŒŒì¼ ìœ„ì¹˜**: `ai/chatbot/stream.py`

**ì£¼ìš” ì±…ì„**: ì±—ë´‡ì˜ í•µì‹¬ ë¡œì§ì„ êµ¬í˜„í•œ í´ë˜ìŠ¤ë¡œ, ëŒ€í™” ì»¨í…ìŠ¤íŠ¸ ê´€ë¦¬, RAG ì²˜ë¦¬, í•¨ìˆ˜ í˜¸ì¶œ, JSON Lines ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ ìƒì„±ì„ ë‹´ë‹¹

#### ì£¼ìš” ë©”ì„œë“œ:

```python
def __init__(self, model: str, system_role: str, instruction: str, **kwargs)
```
- **ì„¤ëª…**: ì±—ë´‡ ì¸ìŠ¤í„´ìŠ¤ ì´ˆê¸°í™”
- **ë§¤ê°œë³€ìˆ˜**:
  - `model`: ì‚¬ìš©í•  GPT ëª¨ë¸ ID (ì˜ˆ: "gpt-4o")
  - `system_role`: ì‹œìŠ¤í…œ ì—­í•  í”„ë¡¬í”„íŠ¸
  - `instruction`: ì±—ë´‡ì—ê²Œ ì£¼ì–´ì§ˆ ì§€ì‹œì‚¬í•­
  - `**kwargs`: ì¶”ê°€ ì„¤ì •(user, assistant ë“±)
- **ì´ˆê¸°í™” ë‚´ìš©**:
  - RagService ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
  - FunctionCalling ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
  - ë©”ì‹œì§€ íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™”

---

```python
async def stream_chat(
    self,
    question: str,
    language: Optional[str] = None,
    enable_rag: bool = True,
    enable_functions: bool = True
) -> AsyncGenerator[str, None]
```
- **ì„¤ëª…**: 9ë‹¨ê³„ í†µí•© ìŠ¤íŠ¸ë¦¬ë° ì²˜ë¦¬ (í•µì‹¬ ë©”ì„œë“œ)
- **ë§¤ê°œë³€ìˆ˜**:
  - `question`: ì‚¬ìš©ì ì§ˆë¬¸
  - `language`: ì‘ë‹µ ì–¸ì–´ (í•œêµ­ì–´/ì˜ì–´)
  - `enable_rag`: RAG ì‚¬ìš© ì—¬ë¶€
  - `enable_functions`: í•¨ìˆ˜ í˜¸ì¶œ ì‚¬ìš© ì—¬ë¶€
- **ë°˜í™˜**: JSON Lines í˜•ì‹ ìŠ¤íŠ¸ë¦¬ë° ì œë„ˆë ˆì´í„°
- **ì²˜ë¦¬ ë‹¨ê³„**:
  1. ë©”ì‹œì§€ ì¶”ê°€ ë° ì–¸ì–´ ì„¤ì •
  2-6. RAG ì²˜ë¦¬ (5ë‹¨ê³„ íŒŒì´í”„ë¼ì¸)
  7. í•¨ìˆ˜ í˜¸ì¶œ ë¶„ì„/ì‹¤í–‰
  8. OpenAI API ìŠ¤íŠ¸ë¦¬ë° í˜¸ì¶œ
  9. ë©”íƒ€ë°ì´í„° ì „ì†¡

---

```python
def _condense_rag_context(self, rag_result: RagResult) -> str
```
- **ì„¤ëª…**: RAG ì»¨í…ìŠ¤íŠ¸ ìš”ì•½ (3500 í† í° ì´ˆê³¼ ì‹œ)
- **ë§¤ê°œë³€ìˆ˜**: `rag_result` - RAG ê²€ìƒ‰ ê²°ê³¼
- **ë°˜í™˜**: ìš”ì•½ëœ ì»¨í…ìŠ¤íŠ¸ ë¬¸ìì—´

---

```python
def _build_final_context(
    self,
    rag_context: Optional[str],
    function_result: Optional[str]
) -> str
```
- **ì„¤ëª…**: ìµœì¢… í”„ë¡¬í”„íŠ¸ êµ¬ì„± (RAG + í•¨ìˆ˜ ê²°ê³¼)
- **ë°˜í™˜**: í†µí•© ì»¨í…ìŠ¤íŠ¸ ë¬¸ìì—´

---

```python
async def _analyze_and_execute_functions(
    self,
    user_message: str
) -> Tuple[Optional[FunctionCallMetadata], Optional[str]]
```
- **ì„¤ëª…**: í•¨ìˆ˜ í˜¸ì¶œ ë¶„ì„ ë° ì‹¤í–‰
- **ë°˜í™˜**: (FunctionCallMetadata, í•¨ìˆ˜ ê²°ê³¼ ë¬¸ìì—´)

---

```python
async def _stream_openai_response(
    self,
    temp_context: Optional[str] = None
) -> AsyncGenerator[Tuple[str, str], None]
```
- **ì„¤ëª…**: OpenAI API ìŠ¤íŠ¸ë¦¬ë° í˜¸ì¶œ
- **ë°˜í™˜**: (chunk_type, content) íŠœí”Œ ìŠ¤íŠ¸ë¦¼
  - chunk_type: "delta" | "function_call"
  - content: ì‘ë‹µ í…ìŠ¤íŠ¸

---

### 2. RagService í´ë˜ìŠ¤ â­ **RAG ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°**

**íŒŒì¼ ìœ„ì¹˜**: `ai/rag/service.py`

**ì£¼ìš” ì±…ì„**: RAG 5ë‹¨ê³„ íŒŒì´í”„ë¼ì¸ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜

#### ì£¼ìš” ë©”ì„œë“œ:

```python
def __init__(self)
```
- **ì„¤ëª…**: RAG ì„œë¹„ìŠ¤ ì´ˆê¸°í™”
- **ì´ˆê¸°í™” ë‚´ìš©**:
  - RegulationGate ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
  - PineconeRetriever ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
  - MongoChunkRepository ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
  - ContextBuilder ì¸ìŠ¤í„´ìŠ¤ ìƒì„±

---

```python
def retrieve_context(self, question: str) -> RagResult
```
- **ì„¤ëª…**: RAG 5ë‹¨ê³„ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰
- **ë§¤ê°œë³€ìˆ˜**: `question` - ì‚¬ìš©ì ì§ˆë¬¸
- **ë°˜í™˜**: `RagResult` (is_regulation, merged_documents_text, source_documents ë“±)
- **ì²˜ë¦¬ ë‹¨ê³„**:
  1. Gate: ê·œì • ì§ˆë¬¸ íŒë‹¨
  2. Retriever: Pinecone ê²€ìƒ‰
  3. Repository: MongoDB ì¡°íšŒ
  4. Context Builder: ë¬¸ì„œ ì¡°ë¦½
  5. Result: ìµœì¢… ê²°ê³¼ ë°˜í™˜

---

```python
@dataclass
class RagResult:
    is_regulation: bool
    merged_documents_text: str  # ë³‘í•©ëœ ë¬¸ì„œ í…ìŠ¤íŠ¸
    source_documents: List[SourceDocument]
    regulation_check_reason: str
    total_chunks: int
    pinecone_query_time_ms: int
    mongo_query_time_ms: int
    # ... ê¸°íƒ€ ë©”íƒ€ë°ì´í„°
```

---

### 3. RegulationGate í´ë˜ìŠ¤

**íŒŒì¼ ìœ„ì¹˜**: `ai/rag/gate.py`

**ì£¼ìš” ì±…ì„**: ì§ˆë¬¸ì´ í•™ì‚¬ ê·œì • ê´€ë ¨ì¸ì§€ LLM ê¸°ë°˜ íŒë‹¨

#### ì£¼ìš” ë©”ì„œë“œ:

```python
def should_use_rag(self, question: str) -> GateDecision
```
- **ì„¤ëª…**: ê·œì • ì§ˆë¬¸ ì—¬ë¶€ íŒë‹¨
- **ë§¤ê°œë³€ìˆ˜**: `question` - ì‚¬ìš©ì ì§ˆë¬¸
- **ë°˜í™˜**: `GateDecision` (is_regulation: bool, reason: str)
- **íŒë‹¨ ê¸°ì¤€**:
  - í•™ì‚¬ ê·œì • ê´€ë ¨ ì§ˆë¬¸ â†’ True
  - ì¼ë°˜ ëŒ€í™” â†’ False

---

### 4. PineconeRetriever í´ë˜ìŠ¤

**íŒŒì¼ ìœ„ì¹˜**: `ai/rag/retriever.py`

**ì£¼ìš” ì±…ì„**: Pinecone ë²¡í„° ê²€ìƒ‰

#### ì£¼ìš” ë©”ì„œë“œ:

```python
def search(self, query: str, top_k: int = 10) -> RetrieverResult
```
- **ì„¤ëª…**: ë²¡í„° ìœ ì‚¬ë„ ê²€ìƒ‰
- **ë§¤ê°œë³€ìˆ˜**:
  - `query`: ê²€ìƒ‰ ì¿¼ë¦¬
  - `top_k`: ê²€ìƒ‰ ê²°ê³¼ ê°œìˆ˜
- **ë°˜í™˜**: `RetrieverResult` (hits: List[dict], chunk_ids: List[str])

---

### 5. MongoChunkRepository í´ë˜ìŠ¤

**íŒŒì¼ ìœ„ì¹˜**: `ai/rag/repository.py`

**ì£¼ìš” ì±…ì„**: MongoDB ë¬¸ì„œ ì €ì¥ì†Œ ì ‘ê·¼

#### ì£¼ìš” ë©”ì„œë“œ:

```python
def find_by_ids(self, chunk_ids: List[str]) -> List[Dict[str, Any]]
```
- **ì„¤ëª…**: chunk_idë¡œ ë¬¸ì„œ ì¡°íšŒ
- **ë§¤ê°œë³€ìˆ˜**: `chunk_ids` - ë¬¸ì„œ ID ëª©ë¡
- **ë°˜í™˜**: ë¬¸ì„œ ëª©ë¡ (list of dict)

---

### 6. ContextBuilder í´ë˜ìŠ¤

**íŒŒì¼ ìœ„ì¹˜**: `ai/rag/RagDocumentPackage.py`

**ì£¼ìš” ì±…ì„**: MongoDB ë¬¸ì„œ ì¡°ë¦½ ë° ë©”íƒ€ë°ì´í„° ì¶”ì¶œ

#### ì£¼ìš” ë©”ì„œë“œ:

```python
def build(
    self,
    documents: List[Dict[str, Any]],
    retriever_result: RetrieverResult
) -> RagDocumentPackage
```
- **ì„¤ëª…**: ë¬¸ì„œ ì¡°ë¦½ ë° ë©”íƒ€ë°ì´í„° ìƒì„±
- **ë§¤ê°œë³€ìˆ˜**:
  - `documents`: MongoDB ë¬¸ì„œ ëª©ë¡
  - `retriever_result`: Pinecone ê²€ìƒ‰ ê²°ê³¼
- **ë°˜í™˜**: `RagDocumentPackage`
  - `merged_documents_text`: ë³‘í•©ëœ ë¬¸ì„œ í…ìŠ¤íŠ¸ (`\n\n`ë¡œ ì—°ê²°)
  - `source_documents`: ì¶œì²˜ ë¬¸ì„œ ëª©ë¡
  - `retrieved_chunks`: ê²€ìƒ‰ëœ ì²­í¬ ìˆ˜
  - `extracted_texts`: ì¶”ì¶œëœ í…ìŠ¤íŠ¸ ëª©ë¡
- **Fallback**: MongoDB ì¡°íšŒ ì‹¤íŒ¨ ì‹œ Pinecone metadata.text ì‚¬ìš©

---

### 7. FunctionCalling í´ë˜ìŠ¤

**íŒŒì¼ ìœ„ì¹˜**: `ai/functions/analyzer.py`

**ì£¼ìš” ì±…ì„**: í•¨ìˆ˜ í˜¸ì¶œ ë¶„ì„ ë° ì‹¤í–‰ì„ ë‹´ë‹¹

#### ì£¼ìš” ë©”ì„œë“œ:

```python
def __init__(self, model: str, available_functions: Optional[Dict] = None)
```
- **ì„¤ëª…**: í•¨ìˆ˜ í˜¸ì¶œ ì¸ìŠ¤í„´ìŠ¤ ì´ˆê¸°í™”
- **ë§¤ê°œë³€ìˆ˜**:
  - `model`: ì‚¬ìš©í•  GPT ëª¨ë¸ ID
  - `available_functions`: ì‚¬ìš© ê°€ëŠ¥í•œ í•¨ìˆ˜ ì‚¬ì „

---

```python
def analyze(
    self,
    user_message: str,
    tools: List[Dict[str, Any]]
) -> Tuple[Optional[str], Optional[str], Optional[Dict]]
```
- **ì„¤ëª…**: ì‚¬ìš©ì ë©”ì‹œì§€ ë¶„ì„í•˜ì—¬ í•„ìš”í•œ í•¨ìˆ˜ í˜¸ì¶œ íŒë‹¨
- **ë§¤ê°œë³€ìˆ˜**:
  - `user_message`: ì‚¬ìš©ì ë©”ì‹œì§€
  - `tools`: ì‚¬ìš© ê°€ëŠ¥í•œ í•¨ìˆ˜ ë„êµ¬ ëª©ë¡
- **ë°˜í™˜**: (í•¨ìˆ˜ëª…, í•¨ìˆ˜ ê²°ê³¼, í•¨ìˆ˜ ì •ë³´)
  - í•¨ìˆ˜ê°€ í•„ìš” ì—†ìœ¼ë©´ `(None, None, None)`
  - í•¨ìˆ˜ í˜¸ì¶œ ì‹œ ì‹¤í–‰ í›„ ê²°ê³¼ ë°˜í™˜

---

## ğŸ“ ë©”íƒ€ë°ì´í„° í´ë˜ìŠ¤ (`/ai/chatbot`)

**íŒŒì¼ ìœ„ì¹˜**: `ai/chatbot/metadata.py`

### 8. RagMetadata

```python
@dataclass
class RagMetadata:
    is_regulation: bool
    source_documents: List[Dict[str, Any]]
    merged_documents_text: str
    regulation_check_reason: str
    total_chunks: int
    retrieved_chunks: int
    pinecone_query_time_ms: int
    mongo_query_time_ms: int
    context_build_time_ms: int
    used_fallback: bool
    fallback_reason: Optional[str] = None
```
- **ì„¤ëª…**: RAG ê²€ìƒ‰ ë©”íƒ€ë°ì´í„°
- **ìš©ë„**: í´ë¼ì´ì–¸íŠ¸ì—ê²Œ RAG ê²€ìƒ‰ ì •ë³´ ì œê³µ
- **í¬í•¨ ì •ë³´**: ì¶œì²˜ ë¬¸ì„œ, ê²€ìƒ‰ ì‹œê°„, Fallback ì—¬ë¶€ ë“±

---

### 9. FunctionCallMetadata

```python
@dataclass
class FunctionCallMetadata:
    function_name: str
    arguments: Dict[str, Any]
    result: str
```
- **ì„¤ëª…**: í•¨ìˆ˜ í˜¸ì¶œ ë©”íƒ€ë°ì´í„°
- **ìš©ë„**: í´ë¼ì´ì–¸íŠ¸ì—ê²Œ í•¨ìˆ˜ í˜¸ì¶œ ì •ë³´ ì œê³µ

---

### 10. ChatMetadata

```python
@dataclass
class ChatMetadata:
    rag: Optional[RagMetadata] = None
    functions: Optional[FunctionCallMetadata] = None
    web_search_status: Optional[str] = None
```
- **ì„¤ëª…**: ì „ì²´ ë©”íƒ€ë°ì´í„° í†µí•©
- **ìš©ë„**: JSON Linesì˜ `metadata` íƒ€ì… ë©”ì‹œì§€ë¡œ ì „ì†¡

---

## ğŸ“ ë ˆê±°ì‹œ ëª¨ë“ˆ (`/chatbotDirectory`)

> **ì°¸ê³ **: ì ì§„ì ìœ¼ë¡œ `/ai` ëª¨ë“ˆë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤‘

### 11. í•¨ìˆ˜ êµ¬í˜„ (functioncalling.py)

#### search_internet()
```python
def search_internet(query: str, max_results: int = 5) -> str
```
- **ì„¤ëª…**: ì›¹ ê²€ìƒ‰ í•¨ìˆ˜
- **ì‚¬ìš© API**: DuckDuckGo
- **ë°˜í™˜**: ê²€ìƒ‰ ê²°ê³¼ ìš”ì•½ ë¬¸ìì—´

---

#### get_halla_cafeteria_menu()
```python
def get_halla_cafeteria_menu(date: str, meal_type: str = "ì¤‘ì‹") -> str
```
- **ì„¤ëª…**: í•™ì‹ ë©”ë‰´ ì¡°íšŒ í•¨ìˆ˜
- **í¬ë¡¤ë§**: BeautifulSoup ì‚¬ìš©
- **ë°˜í™˜**: ë©”ë‰´ ì •ë³´ ë¬¸ìì—´

---

## ğŸ“ ë°ì´í„° ë¡œë”© ëª¨ë“ˆ (`/loding`)

### 12. ë¬¸ì„œ ì²­í‚¹ í•¨ìˆ˜ (documentLoding.py)

#### extract_chunks_finditer()
```python
def extract_chunks_finditer(text: str, doc_num: str, file_name: str) -> List[Dict]
```
- **ì„¤ëª…**: ì¡°í•­ ë‹¨ìœ„ ì²­í‚¹
- **ì •ê·œì‹**: `ì œ\d+ì¡°` íŒ¨í„´ ì‚¬ìš©
- **ë°˜í™˜**: ì²­í¬ ëª©ë¡ (chunk_id, text, metadata í¬í•¨)

---

#### extract_star_tables()
```python
def extract_star_tables(text: str, doc_num: str, file_name: str) -> List[Dict]
```
- **ì„¤ëª…**: ë³„í‘œ ë‹¨ìœ„ ì²­í‚¹
- **ì •ê·œì‹**: `\[ë³„í‘œ \d+\]` íŒ¨í„´ ì‚¬ìš©
- **ë°˜í™˜**: ë³„í‘œ ì²­í¬ ëª©ë¡

---

## ğŸ“ ë°ì´í„° ì ‘ê·¼ ê³„ì¸µ (`/ai/data`)

### 13. MongoDB í´ë¼ì´ì–¸íŠ¸ (mongodb_client.py)

```python
from ai.data.mongodb_client import collection
```
- **ì„¤ëª…**: MongoDB ì—°ê²° ë° ì»¬ë ‰ì…˜ ì œê³µ
- **ì‚¬ìš©**: `collection.find(...)` í˜•íƒœë¡œ ì‚¬ìš©

---

### 14. ë²¡í„° ì—…ë¡œë” (vector_uploader.py)

```python
def upload_to_pinecone(chunks: List[Dict], batch_size: int = 100)
```
- **ì„¤ëª…**: Pineconeì— ì„ë² ë”© ì—…ë¡œë“œ
- **ë§¤ê°œë³€ìˆ˜**:
  - `chunks`: ë¬¸ì„œ ì²­í¬ ëª©ë¡
  - `batch_size`: ë°°ì¹˜ í¬ê¸°
- **ì²˜ë¦¬**: 
  - OpenAI ì„ë² ë”© ìƒì„±
  - Pinecone ì—…ë¡œë“œ
  - ì—ëŸ¬ ì²˜ë¦¬ ë° ì¬ì‹œë„

---

## ğŸ”§ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜

### 15. í† í° ì¹´ìš´íŒ… (ai/chatbot/stream.py)

```python
def _count_tokens(self, text: str) -> int
```
- **ì„¤ëª…**: í…ìŠ¤íŠ¸ì˜ í† í° ìˆ˜ ê³„ì‚°
- **ì‚¬ìš©**: tiktoken ë¼ì´ë¸ŒëŸ¬ë¦¬
- **ë°˜í™˜**: í† í° ìˆ˜ (int)

---

### 16. JSON Lines ìƒì„± (ai/chatbot/stream.py)

```python
def _format_json_line(self, type: str, **kwargs) -> str
```
- **ì„¤ëª…**: JSON Lines í˜•ì‹ ë©”ì‹œì§€ ìƒì„±
- **ë§¤ê°œë³€ìˆ˜**:
  - `type`: "delta" | "metadata" | "done"
  - `**kwargs`: ì¶”ê°€ í•„ë“œ
- **ë°˜í™˜**: JSON ë¬¸ìì—´ + `\n`

**ì˜ˆì‹œ**:
```python
_format_json_line("delta", content="ì•ˆë…•")
# â†’ '{"type":"delta","content":"ì•ˆë…•"}\n'

_format_json_line("metadata", metadata={...})
# â†’ '{"type":"metadata","metadata":{...}}\n'
```

---

## ğŸ“‹ ìš”ì•½

### Phase 2 ì£¼ìš” ë³€ê²½ì‚¬í•­

1. **RAG ëª¨ë“ˆ ë¶„ë¦¬** (`/ai/rag`):
   - Service â†’ Gate â†’ Retriever â†’ Repository â†’ ContextBuilder
   - ë‹¨ì¼ ì±…ì„ ì›ì¹™ ì ìš©
   - ë ˆì´ì–´ë“œ ì•„í‚¤í…ì²˜

2. **ìŠ¤íŠ¸ë¦¬ë° í†µí•©** (`/ai/chatbot/stream.py`):
   - 9ë‹¨ê³„ í†µí•© ì²˜ë¦¬
   - JSON Lines í˜•ì‹
   - ë©”íƒ€ë°ì´í„° ì œê³µ

3. **ë©”íƒ€ë°ì´í„° ì‹œìŠ¤í…œ** (`/ai/chatbot/metadata.py`):
   - RAG, í•¨ìˆ˜ í˜¸ì¶œ ì •ë³´ ì œê³µ
   - í´ë¼ì´ì–¸íŠ¸ íˆ¬ëª…ì„± ì¦ëŒ€

4. **ëª…ëª… ê·œì¹™ ê°œì„ **:
   - `context` â†’ `merged_documents_text` (ì˜ë¯¸ ëª…í™•í™”)
   - `documents` â†’ `retrieved_chunks` (ì—­í•  ëª…í™•í™”)
   - ëª¨ë“  ë³€ìˆ˜ëª… ì¼ê´€ì„± í™•ë³´

---

**ê´€ë ¨ ë¬¸ì„œ**:
- [í”„ë¡œì íŠ¸ êµ¬ì¡°](í”„ë¡œì íŠ¸_êµ¬ì¡°.md) - ì „ì²´ êµ¬ì¡° ë° í´ë” ì„¤ëª…
- [í”„ë¡ íŠ¸ì—”ë“œ API í†µí•© ê°€ì´ë“œ](í”„ë¡ íŠ¸ì—”ë“œ_API_í†µí•©_ê°€ì´ë“œ.md) - JSON Lines API ì‚¬ìš©ë²•
- [ê¸°ëŠ¥ ëª©ë¡](ê¸°ëŠ¥_ëª©ë¡.md) - ê¸°ëŠ¥ë³„ ìƒì„¸ ì„¤ëª…