# ì±—ë´‡ ë¡œì§ ë¶„ë¦¬ ê³„íš (Phase 3)

> **ëª©í‘œ**: routes.pyì˜ ë³µì¡í•œ ì±—ë´‡ ë¡œì§ì„ ChatbotStreamìœ¼ë¡œ ì™„ì „íˆ ë¶„ë¦¬í•˜ì—¬, í”„ë¡ íŠ¸ì—”ë“œê°€ ë‹¨ìˆœíˆ ì±—ë´‡ ê°ì²´ë§Œ importí•˜ë©´ ëª¨ë“  ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ë§Œë“¤ê¸°

**ì‘ì„±ì¼**: 2025-10-09  
**ìƒíƒœ**: ì„¤ê³„ ë‹¨ê³„

---

## ğŸ“ í˜„ì¬ íŒŒì¼ êµ¬ì¡°

```
app/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ main.py                          # FastAPI ì•± ì§„ì…ì 
â”œâ”€â”€ apikey.env                       # í™˜ê²½ ë³€ìˆ˜
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ pyproject.toml
â”œâ”€â”€ uv.lock
â”‚
â”œâ”€â”€ api/                             # API ë¼ìš°í„°
â”‚   â””â”€â”€ routes.py                    # âš ï¸ 440ì¤„ì˜ ë³µì¡í•œ ì±—ë´‡ ë¡œì§ í¬í•¨
â”‚
â”œâ”€â”€ chatbotDirectory/                # ì±—ë´‡ í•µì‹¬ ë¡œì§
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ chatbot.py                   # ChatbotStream í´ë˜ìŠ¤
â”‚   â”œâ”€â”€ character.py                 # ìºë¦­í„° ì„¤ì •
â”‚   â”œâ”€â”€ common.py                    # ê³µí†µ ì„¤ì • (model, client)
â”‚   â”œâ”€â”€ functioncalling.py           # í•¨ìˆ˜ í˜¸ì¶œ ë¶„ì„/ì‹¤í–‰
â”‚   â””â”€â”€ rag/                         # RAG ëª¨ë“ˆ (Phase 2 ì™„ë£Œ)
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ service.py               # RagService (ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°)
â”‚       â”œâ”€â”€ gate.py                  # ê·œì • ì§ˆë¬¸ ë¶„ë¥˜
â”‚       â”œâ”€â”€ retriever.py             # Pinecone ë²¡í„° ê²€ìƒ‰
â”‚       â”œâ”€â”€ repository.py            # MongoDB ë¬¸ì„œ ì¡°íšŒ
â”‚       â”œâ”€â”€ context_builder.py       # ì»¨í…ìŠ¤íŠ¸ ì¡°ë¦½
â”‚       â””â”€â”€ constants.py
â”‚
â”œâ”€â”€ loding/                          # âš ï¸ ì˜¤íƒ€ (loading â†’ loding)
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ documentLoding.py            # ë¬¸ì„œ ë¡œë”©
â”‚   â”œâ”€â”€ mongodbConnect.py            # MongoDB ì—°ê²°
â”‚   â”œâ”€â”€ vector_db_upload.py          # ë²¡í„° DB ì—…ë¡œë“œ
â”‚   â””â”€â”€ ì„ì‹œ/
â”‚
â”œâ”€â”€ pdfs/                            # ê·œì • ë¬¸ì„œ ì›ë³¸ (30+ hwp/hwpx íŒŒì¼)
â”‚
â”œâ”€â”€ docs/                            # ë¬¸ì„œ
â”‚   â”œâ”€â”€ RAG_ë¶„ë¦¬_ê³„íš.md
â”‚   â”œâ”€â”€ ì±—ë´‡_ë¡œì§_ë¶„ë¦¬_ê³„íš.md        # ğŸ“ í˜„ì¬ íŒŒì¼
â”‚   â””â”€â”€ progress_log.md
â”‚
â”œâ”€â”€ test.py                          # âš ï¸ ë£¨íŠ¸ì— í©ì–´ì§„ í…ŒìŠ¤íŠ¸ íŒŒì¼
â”œâ”€â”€ test_stream_chat.py
â””â”€â”€ .venv/                           # Python ê°€ìƒí™˜ê²½
```

### ğŸš¨ í˜„ì¬ êµ¬ì¡°ì˜ ë¬¸ì œì 

1. **ë””ë ‰í† ë¦¬ ëª…ëª… ë¬¸ì œ**
   - `loding` â†’ ì˜¤íƒ€ (ì˜¬ë°”ë¥¸ ì´ë¦„: `loading` ë˜ëŠ” `data`)
   - `chatbotDirectory` â†’ ì¼ê´€ì„± ì—†ëŠ” ëª…ëª… (camelCase vs snake_case)

2. **AI ê´€ë ¨ íŒŒì¼ ë¶„ì‚°**
   - ì±—ë´‡, RAG, í•¨ìˆ˜ í˜¸ì¶œ, ë°ì´í„° ë¡œë”©ì´ ì—¬ëŸ¬ ë””ë ‰í† ë¦¬ì— í©ì–´ì§
   - AI ê´€ë ¨ ë¡œì§ì„ í•œê³³ì— ëª¨ì•„ì•¼ ê´€ë¦¬ ìš©ì´

3. **í…ŒìŠ¤íŠ¸ íŒŒì¼ ë¶„ì‚°**
   - `test.py`, `test_stream_chat.py`ê°€ ë£¨íŠ¸ì— ìœ„ì¹˜
   - í†µí•© í…ŒìŠ¤íŠ¸ ë””ë ‰í† ë¦¬ í•„ìš”

4. **ë¼ìš°í„°ì— ë¡œì§ ì§‘ì¤‘**
   - `api/routes.py`ì— 440ì¤„ì˜ ì±—ë´‡ ë¡œì§
   - ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ê³¼ ë¼ìš°íŒ… ì±…ì„ ë¶„ë¦¬ í•„ìš”

---

## ğŸ¯ ê°œì„ ëœ íŒŒì¼ êµ¬ì¡° (Phase 3 ëª©í‘œ)

```
app/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ main.py                          # FastAPI ì•± ì§„ì…ì 
â”œâ”€â”€ apikey.env
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ pyproject.toml
â”œâ”€â”€ uv.lock
â”‚
â”œâ”€â”€ api/                             # ğŸ”„ API ë¼ìš°í„° (ë‹¨ìˆœí™”)
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ routes.py                    # âœ… 10ì¤„ ë¯¸ë§Œ (chatbot.stream_chat() í˜¸ì¶œë§Œ)
â”‚
â”œâ”€â”€ ai/                              # ğŸ†• AI ê´€ë ¨ í†µí•© ë””ë ‰í† ë¦¬
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚
â”‚   â”œâ”€â”€ chatbot/                     # ì±—ë´‡ í•µì‹¬ (ê¸°ì¡´ chatbotDirectory)
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ stream.py                # âœ… ChatbotStream (stream_chat í¬í•¨)
â”‚   â”‚   â”œâ”€â”€ metadata.py              # ğŸ†• RagMetadata, FunctionCallMetadata, ChatMetadata
â”‚   â”‚   â”œâ”€â”€ character.py             # ìºë¦­í„° ì„¤ì •
â”‚   â”‚   â””â”€â”€ config.py                # ê³µí†µ ì„¤ì • (model, client)
â”‚   â”‚
â”‚   â”œâ”€â”€ rag/                         # RAG ëª¨ë“ˆ (Phase 2 ì™„ë£Œ)
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ service.py               # RagService
â”‚   â”‚   â”œâ”€â”€ gate.py                  # ê·œì • ì§ˆë¬¸ ë¶„ë¥˜
â”‚   â”‚   â”œâ”€â”€ retriever.py             # Pinecone ë²¡í„° ê²€ìƒ‰
â”‚   â”‚   â”œâ”€â”€ repository.py            # MongoDB ë¬¸ì„œ ì¡°íšŒ
â”‚   â”‚   â”œâ”€â”€ context_builder.py       # ì»¨í…ìŠ¤íŠ¸ ì¡°ë¦½
â”‚   â”‚   â””â”€â”€ constants.py
â”‚   â”‚
â”‚   â”œâ”€â”€ functions/                   # í•¨ìˆ˜ í˜¸ì¶œ (ê¸°ì¡´ functioncalling.py)
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ analyzer.py              # FunctionCalling í´ë˜ìŠ¤
â”‚   â”‚   â”œâ”€â”€ tools.py                 # ë„êµ¬ ì •ì˜ (tools ë¦¬ìŠ¤íŠ¸)
â”‚   â”‚   â”œâ”€â”€ web_search.py            # ì›¹ ê²€ìƒ‰ í•¨ìˆ˜
â”‚   â”‚   â”œâ”€â”€ cafeteria.py             # í•™ì‹ ë©”ë‰´ í•¨ìˆ˜
â”‚   â”‚   â”œâ”€â”€ notice.py                # ê³µì§€ì‚¬í•­ í•¨ìˆ˜
â”‚   â”‚   â””â”€â”€ schedule.py              # í•™ì‚¬ì¼ì • í•¨ìˆ˜
â”‚   â”‚
â”‚   â””â”€â”€ data/                        # ğŸ”„ ë°ì´í„° ê´€ë ¨ (ê¸°ì¡´ loding)
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ document_loader.py       # ë¬¸ì„œ ë¡œë”© (ê¸°ì¡´ documentLoding.py)
â”‚       â”œâ”€â”€ mongodb_client.py        # MongoDB ì—°ê²° (ê¸°ì¡´ mongodbConnect.py)
â”‚       â””â”€â”€ vector_uploader.py       # ë²¡í„° DB ì—…ë¡œë“œ (ê¸°ì¡´ vector_db_upload.py)
â”‚
â”œâ”€â”€ pdfs/                            # ê·œì • ë¬¸ì„œ ì›ë³¸
â”‚
â”œâ”€â”€ docs/                            # ë¬¸ì„œ
â”‚   â”œâ”€â”€ RAG_ë¶„ë¦¬_ê³„íš.md
â”‚   â”œâ”€â”€ ì±—ë´‡_ë¡œì§_ë¶„ë¦¬_ê³„íš.md
â”‚   â””â”€â”€ progress_log.md
â”‚
â”œâ”€â”€ tests/                           # ğŸ†• í…ŒìŠ¤íŠ¸ í†µí•© ë””ë ‰í† ë¦¬
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ test_chatbot.py              # ì±—ë´‡ í…ŒìŠ¤íŠ¸ (ê¸°ì¡´ test.py)
â”‚   â”œâ”€â”€ test_stream_chat.py          # ìŠ¤íŠ¸ë¦¬ë° í…ŒìŠ¤íŠ¸
â”‚   â”œâ”€â”€ test_rag.py                  # RAG í…ŒìŠ¤íŠ¸
â”‚   â””â”€â”€ test_functions.py            # í•¨ìˆ˜ í˜¸ì¶œ í…ŒìŠ¤íŠ¸
â”‚
â””â”€â”€ .venv/
```

---

## ğŸ”„ ì£¼ìš” ë³€ê²½ ì‚¬í•­

### 1. AI ê´€ë ¨ í†µí•© (`ai/` ë””ë ‰í† ë¦¬ ì‹ ì„¤)

**ë³€ê²½ ì „:**
```
app/
â”œâ”€â”€ chatbotDirectory/
â”œâ”€â”€ loding/
â””â”€â”€ (functioncallingì€ chatbotDirectory ë‚´ë¶€)
```

**ë³€ê²½ í›„:**
```
app/
â””â”€â”€ ai/
    â”œâ”€â”€ chatbot/      # ì±—ë´‡ ìŠ¤íŠ¸ë¦¬ë°, ë©”íƒ€ë°ì´í„°
    â”œâ”€â”€ rag/          # RAG ê²€ìƒ‰
    â”œâ”€â”€ functions/    # í•¨ìˆ˜ í˜¸ì¶œ (ì›¹ê²€ìƒ‰, í•™ì‹ ë“±)
    â””â”€â”€ data/         # ë°ì´í„° ë¡œë”©, MongoDB, ë²¡í„° ì—…ë¡œë“œ
```

**ì¥ì :**
- AI ê´€ë ¨ ëª¨ë“  ë¡œì§ì„ í•œê³³ì—ì„œ ê´€ë¦¬
- ëª…í™•í•œ ê³„ì¸µ êµ¬ì¡° (chatbot â†’ rag, functions ì˜ì¡´)
- import ê²½ë¡œ ì¼ê´€ì„±: `from app.ai.chatbot import ...`

---

### 2. ì±—ë´‡ ëª¨ë“ˆ ì¬êµ¬ì„± (`ai/chatbot/`)

**ë³€ê²½ ì „:**
```python
# chatbotDirectory/chatbot.py (422ì¤„)
class ChatbotStream:
    def __init__(self, model, system_role, instruction, **kwargs):
        # ...
    
    def _send_request_Stream(self, temp_context=None):
        # OpenAI ìŠ¤íŠ¸ë¦¬ë° ë¡œì§
```

**ë³€ê²½ í›„:**
```python
# ai/chatbot/stream.py (~800ì¤„)
from .metadata import RagMetadata, FunctionCallMetadata, ChatMetadata

class ChatbotStream:
    async def stream_chat(self, message: str, language: str = "KOR"):
        """í†µí•© ìŠ¤íŠ¸ë¦¬ë° ë©”ì„œë“œ (routes.py ë¡œì§ ëª¨ë‘ í¡ìˆ˜)"""
        # 1. ì–¸ì–´ë³„ ì§€ì¹¨ ì¶”ê°€
        # 2. RAG ì»¨í…ìŠ¤íŠ¸ ì¤€ë¹„
        # 3. í•¨ìˆ˜ í˜¸ì¶œ ë¶„ì„/ì‹¤í–‰
        # 4. ìµœì¢… ì»¨í…ìŠ¤íŠ¸ êµ¬ì„±
        # 5. ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ ìƒì„±
        # 6. ë©”íƒ€ë°ì´í„° ì „ì†¡
        pass
```

```python
# ai/chatbot/metadata.py (ìƒˆ íŒŒì¼)
@dataclass
class RagMetadata:
    """RAG ê²€ìƒ‰ ë©”íƒ€ë°ì´í„°"""
    is_regulation: bool
    gate_reason: str
    context_source: str
    # ...

@dataclass
class FunctionCallMetadata:
    """í•¨ìˆ˜ í˜¸ì¶œ ë©”íƒ€ë°ì´í„°"""
    name: str
    arguments: Dict[str, Any]
    output: str
    # ...

@dataclass
class ChatMetadata:
    """ì±—ë´‡ ì‘ë‹µ ì „ì²´ ë©”íƒ€ë°ì´í„°"""
    rag: Optional[RagMetadata] = None
    functions: List[FunctionCallMetadata] = None
    web_search_status: Optional[str] = None
```

---

### 3. í•¨ìˆ˜ í˜¸ì¶œ ëª¨ë“ˆí™” (`ai/functions/`)

**ë³€ê²½ ì „:**
```python
# chatbotDirectory/functioncalling.py (ëª¨ë“  í•¨ìˆ˜ê°€ í•˜ë‚˜ì˜ íŒŒì¼)
class FunctionCalling:
    # ...

def search_internet(query, chat_context):
    # ...

def get_halla_cafeteria_menu(date, meal):
    # ...

tools = [...]  # ëª¨ë“  ë„êµ¬ ì •ì˜
```

**ë³€ê²½ í›„:**
```python
# ai/functions/analyzer.py
class FunctionCalling:
    """í•¨ìˆ˜ í˜¸ì¶œ ë¶„ì„ ë° ì‹¤í–‰"""
    def analyze(self, user_message, tools):
        # ...

# ai/functions/web_search.py
def search_internet(query: str, chat_context: List[Dict]) -> str:
    """ì›¹ ê²€ìƒ‰ í•¨ìˆ˜"""
    # ...

# ai/functions/cafeteria.py
def get_halla_cafeteria_menu(date: str, meal: Optional[str] = None) -> str:
    """í•™ì‹ ë©”ë‰´ ì¡°íšŒ"""
    # ...

# ai/functions/tools.py
from .web_search import search_internet
from .cafeteria import get_halla_cafeteria_menu

tools = [
    {
        "type": "function",
        "function": {
            "name": "search_internet",
            # ...
        }
    },
    # ...
]
```

**ì¥ì :**
- í•¨ìˆ˜ë³„ íŒŒì¼ ë¶„ë¦¬ë¡œ ìœ ì§€ë³´ìˆ˜ ìš©ì´
- ìƒˆ í•¨ìˆ˜ ì¶”ê°€ ì‹œ ë…ë¦½ì ì¸ íŒŒì¼ë¡œ ê´€ë¦¬
- í…ŒìŠ¤íŠ¸ ì‘ì„± ìš©ì´ (`test_functions.py`ì—ì„œ í•¨ìˆ˜ë³„ í…ŒìŠ¤íŠ¸)

---

### 4. ë°ì´í„° ì²˜ë¦¬ í†µí•© (`ai/data/`)

**ë³€ê²½ ì „:**
```
loding/                    # âš ï¸ ì˜¤íƒ€
â”œâ”€â”€ documentLoding.py      # âš ï¸ ì˜¤íƒ€
â”œâ”€â”€ mongodbConnect.py
â””â”€â”€ vector_db_upload.py
```

**ë³€ê²½ í›„:**
```
ai/data/
â”œâ”€â”€ document_loader.py     # âœ… ìˆ˜ì •
â”œâ”€â”€ mongodb_client.py      # âœ… ëª…í™•í•œ ì´ë¦„
â””â”€â”€ vector_uploader.py     # âœ… ì¼ê´€ì„±
```

**ë³€ê²½ ì´ìœ :**
- ì˜¤íƒ€ ìˆ˜ì • (`loding` â†’ `data`, `documentLoding` â†’ `document_loader`)
- snake_case ëª…ëª… ê·œì¹™ ì¼ê´€ì„±
- AI ê´€ë ¨ ë°ì´í„° ì²˜ë¦¬ë¥¼ `ai/` í•˜ìœ„ë¡œ ì´ë™

---

### 5. í…ŒìŠ¤íŠ¸ í†µí•© (`tests/`)

**ë³€ê²½ ì „:**
```
app/
â”œâ”€â”€ test.py
â””â”€â”€ test_stream_chat.py
```

**ë³€ê²½ í›„:**
```
tests/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ test_chatbot.py         # ì±—ë´‡ ê¸°ë³¸ ê¸°ëŠ¥
â”œâ”€â”€ test_stream_chat.py     # ìŠ¤íŠ¸ë¦¬ë° í…ŒìŠ¤íŠ¸
â”œâ”€â”€ test_rag.py             # RAG ëª¨ë“ˆ í…ŒìŠ¤íŠ¸
â””â”€â”€ test_functions.py       # í•¨ìˆ˜ í˜¸ì¶œ í…ŒìŠ¤íŠ¸
```

**ì¥ì :**
- í…ŒìŠ¤íŠ¸ íŒŒì¼ ì¤‘ì•™ ê´€ë¦¬
- ëª¨ë“ˆë³„ í…ŒìŠ¤íŠ¸ ë¶„ë¦¬
- `pytest` ì‹¤í–‰ ì‹œ ìë™ ë°œê²¬

---

### 6. API ë¼ìš°í„° ë‹¨ìˆœí™” (`api/routes.py`)

**ë³€ê²½ ì „ (440ì¤„):**
```python
@router.post("/chat")
async def stream_chat(user_input: UserRequest):
    # 1. ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
    chatbot.add_user_message_in_context(user_input.message)
    
    # 2. ì–¸ì–´ë³„ ì§€ì¹¨ ì¶”ê°€
    instruction_map = {...}
    chatbot.context[-1]["content"] += " " + instruction
    
    # 3. RAG ì»¨í…ìŠ¤íŠ¸ ì¤€ë¹„ (80ì¤„)
    rag_result = chatbot.rag_service.build_context(...)
    condense_prompt = [...]
    condensed = client.responses.create(...)
    
    # 4. í•¨ìˆ˜ í˜¸ì¶œ ë¶„ì„/ì‹¤í–‰ (120ì¤„)
    analyzed = func_calling.analyze(...)
    for tool_call in analyzed:
        func_response = func_to_call(**func_args)
        func_msgs.extend([...])
    
    # 5. í•™ì‹ ë³´ê°• ë¡œì§ (40ì¤„)
    # ...
    
    # 6. ìµœì¢… ì»¨í…ìŠ¤íŠ¸ êµ¬ì„± (160ì¤„)
    sections = []
    # ...
    
    # 7. ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ ìƒì„± (60ì¤„)
    async def generate_with_tool():
        # ...
    
    return StreamingResponse(generate_with_tool(), media_type="text/plain")
```

**ë³€ê²½ í›„ (~10ì¤„):**
```python
from app.ai.chatbot import ChatbotStream
from app.ai.chatbot.config import model

chatbot = ChatbotStream(
    model=model.advanced,
    system_role="...",
    instruction="...",
)

@router.post("/chat")
async def stream_chat(user_input: UserRequest):
    """ì±—ë´‡ ìŠ¤íŠ¸ë¦¬ë° ì—”ë“œí¬ì¸íŠ¸"""
    return StreamingResponse(
        chatbot.stream_chat(
            message=user_input.message,
            language=user_input.language
        ),
        media_type="application/x-ndjson"
    )
```

---

## ğŸ”€ Import ê²½ë¡œ ë³€ê²½

### Before (í˜„ì¬)
```python
from app.chatbotDirectory.chatbot import ChatbotStream
from app.chatbotDirectory.functioncalling import FunctionCalling, tools
from app.chatbotDirectory.common import model, client
from app.loding.vector_db_upload import get_embedding, index
from app.loding.mongodbConnect import MongoDBClient
```

### After (Phase 3)
```python
# ì±—ë´‡
from app.ai.chatbot import ChatbotStream
from app.ai.chatbot.metadata import RagMetadata, FunctionCallMetadata
from app.ai.chatbot.config import model, client

# RAG
from app.ai.rag import RagService

# í•¨ìˆ˜ í˜¸ì¶œ
from app.ai.functions import FunctionCalling
from app.ai.functions.tools import tools

# ë°ì´í„°
from app.ai.data.vector_uploader import get_embedding, index
from app.ai.data.mongodb_client import MongoDBClient
```

**ì¥ì :**
- ëª…í™•í•œ ê³„ì¸µ êµ¬ì¡° (`app.ai.*`)
- ì¼ê´€ëœ ëª…ëª… ê·œì¹™ (snake_case)
- IDE ìë™ì™„ì„± ì¹œí™”ì 

---

## ğŸ“Œ í˜„ì¬ ë¬¸ì œì 

### 1. routes.pyì— ì±—ë´‡ ë¡œì§ì´ ê°•í•˜ê²Œ ê²°í•©ë¨ (440ì¤„)

```python
# í˜„ì¬ routes.pyì˜ /chat ì—”ë“œí¬ì¸íŠ¸ êµ¬ì¡°
@router.post("/chat")
async def stream_chat(user_input: UserRequest):
    # 1) ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€ (5ì¤„)
    chatbot.add_user_message_in_context(user_input.message)
    
    # 2) ì–¸ì–´ë³„ ì§€ì¹¨ ì¶”ê°€ (10ì¤„)
    instruction_map = {...}
    chatbot.context[-1]["content"] += " " + instruction
    
    # 3) RAG ì»¨í…ìŠ¤íŠ¸ ì¤€ë¹„ (80ì¤„)
    rag_result = chatbot.rag_service.build_context(...)
    condense_prompt = [...]  # ê¸´ ê·œì • ë¬¸ì„œ ìš”ì•½
    condensed = client.responses.create(...)
    
    # 4) í•¨ìˆ˜ í˜¸ì¶œ ë¶„ì„/ì‹¤í–‰ (120ì¤„)
    analyzed = func_calling.analyze(...)
    for tool_call in analyzed:
        func_response = func_to_call(**func_args)
        func_msgs.extend([...])
    
    # 5) í•™ì‹ ë³´ê°• ë¡œì§ (40ì¤„)
    if cafeteria_keywords and not already_called:
        caf_out = get_cafeteria_fn(**caf_args)
    
    # 6) ìµœì¢… ì»¨í…ìŠ¤íŠ¸ êµ¬ì„± (160ì¤„)
    sections = []
    sections.append("[ì‚¬ìš©ìì¿¼ë¦¬ì§€ì¹¨]...")
    sections.append("[ê¸°ì–µê²€ìƒ‰ì§€ì¹¨]...")
    sections.append("[ì›¹ê²€ìƒ‰ì§€ì¹¨]...")
    temp_context.append({"role": "system", "content": "\n\n".join(sections)})
    
    # 7) ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ ìƒì„± (60ì¤„)
    async def generate_with_tool():
        stream = client.responses.create(...)
        for event in stream:
            yield event.delta
    
    return StreamingResponse(generate_with_tool(), media_type="text/plain")
```

**ë¬¸ì œì :**
- âŒ í”„ë¡ íŠ¸ì—”ë“œê°€ RAG ë¡œì§, í•¨ìˆ˜ í˜¸ì¶œ, ì»¨í…ìŠ¤íŠ¸ êµ¬ì„±ì„ ëª¨ë‘ ì´í•´í•´ì•¼ í•¨
- âŒ ì±—ë´‡ ì‚¬ìš©ì„ ìœ„í•´ 440ì¤„ì˜ ë³µì¡í•œ ì½”ë“œ í•„ìš”
- âŒ ì¬ì‚¬ìš© ë¶ˆê°€ëŠ¥ (ë‹¤ë¥¸ ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ì±—ë´‡ ì‚¬ìš© ì‹œ ì½”ë“œ ì¤‘ë³µ)
- âŒ í…ŒìŠ¤íŠ¸ ì–´ë ¤ì›€ (ë¼ìš°í„° ë ˆë²¨ì—ì„œë§Œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥)

---

## âœ… ëª©í‘œ êµ¬ì¡°

### í”„ë¡ íŠ¸ì—”ë“œê°€ ì›í•˜ëŠ” ë‹¨ìˆœí•¨

```python
# ë¦¬íŒ©í„°ë§ í›„: routes.py (10ì¤„ ë¯¸ë§Œ)
@router.post("/chat")
async def stream_chat(user_input: UserRequest):
    """
    ì±—ë´‡ ìŠ¤íŠ¸ë¦¬ë° ì—”ë“œí¬ì¸íŠ¸
    - ëª¨ë“  ë¡œì§ì€ ChatbotStream.stream_chat()ì— ìœ„ì„
    - ë¼ìš°í„°ëŠ” ë‹¨ìˆœíˆ ìš”ì²­/ì‘ë‹µë§Œ ì²˜ë¦¬
    """
    return StreamingResponse(
        chatbot.stream_chat(
            message=user_input.message,
            language=user_input.language
        ),
        media_type="application/x-ndjson"  # JSON Lines í˜•ì‹
    )
```

### ChatbotStreamì´ ì œê³µí•  ì¸í„°í˜ì´ìŠ¤

```python
class ChatbotStream:
    async def stream_chat(
        self, 
        message: str, 
        language: str = "KOR"
    ) -> AsyncGenerator[str, None]:
        """
        í†µí•© ì±—ë´‡ ìŠ¤íŠ¸ë¦¬ë° ë©”ì„œë“œ
        
        Args:
            message: ì‚¬ìš©ì ì§ˆë¬¸
            language: ì‘ë‹µ ì–¸ì–´ (KOR, ENG, VI, JPN, CHN, UZB, MNG, IDN)
        
        Yields:
            JSON Lines í˜•ì‹ì˜ ë¬¸ìì—´:
            - {"type": "delta", "content": "í…ìŠ¤íŠ¸ ì²­í¬"}
            - {"type": "metadata", "rag": {...}, "functions": [...]}
            - {"type": "done"}
        
        ì²˜ë¦¬ íë¦„:
            1. ì–¸ì–´ë³„ ì§€ì¹¨ ì¶”ê°€
            2. RAG ì»¨í…ìŠ¤íŠ¸ ì¤€ë¹„ (ê·œì • ê²€ìƒ‰)
            3. í•¨ìˆ˜ í˜¸ì¶œ ë¶„ì„/ì‹¤í–‰ (ì›¹ê²€ìƒ‰, í•™ì‹ ë“±)
            4. ìµœì¢… ì»¨í…ìŠ¤íŠ¸ êµ¬ì„±
            5. OpenAI ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ ìƒì„±
            6. ë©”íƒ€ë°ì´í„° ì „ì†¡ (RAG ê²°ê³¼, í•¨ìˆ˜ í˜¸ì¶œ ë‚´ì—­)
        """
        pass
```

---

## ğŸ“ ìƒì„¸ ì„¤ê³„

### 1. ë°ì´í„° êµ¬ì¡° ì •ì˜

#### 1.1 RagMetadata í´ë˜ìŠ¤

```python
from dataclasses import dataclass
from typing import Optional, List, Dict, Any

@dataclass
class RagMetadata:
    """RAG ê²€ìƒ‰ ê²°ê³¼ ë©”íƒ€ë°ì´í„°"""
    
    # ê¸°ë³¸ ì •ë³´
    is_regulation: bool
    """ê·œì • ì§ˆë¬¸ ì—¬ë¶€ (gate íŒë‹¨ ê²°ê³¼)"""
    
    gate_reason: str
    """gate íŒë‹¨ ê·¼ê±° (LLM ì¶”ë¡  ë˜ëŠ” í‚¤ì›Œë“œ ë§¤ì¹­)"""
    
    # ì»¨í…ìŠ¤íŠ¸ ì†ŒìŠ¤
    context_source: str
    """ì»¨í…ìŠ¤íŠ¸ ì¶œì²˜: "mongo" (DB ë³¸ë¬¸) | "preview" (Pinecone ë¯¸ë¦¬ë³´ê¸°) | "none" (ìë£Œ ì—†ìŒ)"""
    
    # ê²€ìƒ‰ í†µê³„
    hits_count: int
    """Pinecone ê²€ìƒ‰ íˆíŠ¸ ìˆ˜"""
    
    document_count: int
    """MongoDBì—ì„œ ê°€ì ¸ì˜¨ ë¬¸ì„œ ìˆ˜"""
    
    preview_count: int
    """Pinecone ë¯¸ë¦¬ë³´ê¸° ì‚¬ìš© ìˆ˜ (fallback)"""
    
    # ì›ë³¸ ë°ì´í„° (ë””ë²„ê·¸/ê´€ë¦¬ììš©)
    chunk_ids: Optional[List[str]] = None
    """MongoDB ì²­í¬ ID ëª©ë¡"""
    
    condensed_context: Optional[str] = None
    """ìš”ì•½ëœ ì»¨í…ìŠ¤íŠ¸ (LLMìœ¼ë¡œ ê°€ê³µëœ ë²„ì „)"""

    def to_dict(self) -> Dict[str, Any]:
        """JSON ì§ë ¬í™”ìš© ë”•ì…”ë„ˆë¦¬ ë³€í™˜"""
        return {
            "is_regulation": self.is_regulation,
            "gate_reason": self.gate_reason,
            "context_source": self.context_source,
            "hits_count": self.hits_count,
            "document_count": self.document_count,
            "preview_count": self.preview_count,
            "chunk_ids": self.chunk_ids,
            "has_condensed_context": bool(self.condensed_context),
        }
```

#### 1.2 FunctionCallMetadata í´ë˜ìŠ¤

```python
@dataclass
class FunctionCallMetadata:
    """í•¨ìˆ˜ í˜¸ì¶œ ê²°ê³¼ ë©”íƒ€ë°ì´í„°"""
    
    name: str
    """í•¨ìˆ˜ ì´ë¦„"""
    
    arguments: Dict[str, Any]
    """í•¨ìˆ˜ ì¸ì"""
    
    output: str
    """í•¨ìˆ˜ ì‹¤í–‰ ê²°ê³¼"""
    
    call_id: str
    """í˜¸ì¶œ ID"""
    
    is_fallback: bool = False
    """ë³´ê°• í˜¸ì¶œ ì—¬ë¶€ (LLMì´ ì•„ë‹Œ ê·œì¹™ ê¸°ë°˜ í˜¸ì¶œ)"""

    def to_dict(self) -> Dict[str, Any]:
        return {
            "name": self.name,
            "arguments": self.arguments,
            "output": self.output[:200] + "..." if len(self.output) > 200 else self.output,  # ì¶•ì•½
            "call_id": self.call_id,
            "is_fallback": self.is_fallback,
        }
```

#### 1.3 ChatMetadata í´ë˜ìŠ¤ (ì „ì²´ ë©”íƒ€ë°ì´í„° ì»¨í…Œì´ë„ˆ)

```python
@dataclass
class ChatMetadata:
    """ì±—ë´‡ ì‘ë‹µ ì „ì²´ ë©”íƒ€ë°ì´í„°"""
    
    rag: Optional[RagMetadata] = None
    """RAG ê²€ìƒ‰ ë©”íƒ€ë°ì´í„° (ê·œì • ì§ˆë¬¸ì¸ ê²½ìš°ë§Œ)"""
    
    functions: List[FunctionCallMetadata] = None
    """í•¨ìˆ˜ í˜¸ì¶œ ë©”íƒ€ë°ì´í„° ëª©ë¡"""
    
    web_search_status: Optional[str] = None
    """ì›¹ê²€ìƒ‰ ìƒíƒœ: "ok" | "empty-or-error" | "not-run" """
    
    def __post_init__(self):
        if self.functions is None:
            self.functions = []
    
    def to_dict(self) -> Dict[str, Any]:
        return {
            "rag": self.rag.to_dict() if self.rag else None,
            "functions": [f.to_dict() for f in self.functions],
            "web_search_status": self.web_search_status,
        }
```

---

### 2. ChatbotStream.stream_chat() êµ¬í˜„ ê³„íš

#### 2.1 ë©”ì„œë“œ ì‹œê·¸ë‹ˆì²˜

```python
async def stream_chat(
    self, 
    message: str, 
    language: str = "KOR"
) -> AsyncGenerator[str, None]:
    """
    í†µí•© ì±—ë´‡ ìŠ¤íŠ¸ë¦¬ë° ë©”ì„œë“œ
    
    í˜„ì¬ routes.pyì˜ ëª¨ë“  ë¡œì§ì„ ì—¬ê¸°ë¡œ ì´ë™:
    - ì–¸ì–´ë³„ ì§€ì¹¨ ì¶”ê°€
    - RAG ì»¨í…ìŠ¤íŠ¸ ì¤€ë¹„ (ìš”ì•½ í¬í•¨)
    - í•¨ìˆ˜ í˜¸ì¶œ ë¶„ì„/ì‹¤í–‰
    - í•™ì‹ ë³´ê°• ë¡œì§
    - ìµœì¢… ì»¨í…ìŠ¤íŠ¸ êµ¬ì„±
    - ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ ìƒì„±
    - ë©”íƒ€ë°ì´í„° ì „ì†¡
    """
```

#### 2.2 ì²˜ë¦¬ íë¦„ (Pseudo Code)

```python
async def stream_chat(self, message: str, language: str = "KOR"):
    # === 1ë‹¨ê³„: ì´ˆê¸°í™” ===
    self.add_user_message_in_context(message)
    metadata = ChatMetadata()
    
    # === 2ë‹¨ê³„: ì–¸ì–´ë³„ ì§€ì¹¨ ì¶”ê°€ ===
    instruction = self._get_language_instruction(language)
    self.context[-1]["content"] += " " + instruction
    
    # === 3ë‹¨ê³„: RAG ì»¨í…ìŠ¤íŠ¸ ì¤€ë¹„ ===
    rag_result = self.rag_service.build_context(message)
    condensed_rag = None
    if rag_result.context_text:
        condensed_rag = await self._condense_rag_context(
            message, rag_result.context_text
        )
        metadata.rag = RagMetadata(
            is_regulation=rag_result.is_regulation,
            gate_reason=rag_result.gate_reason,
            context_source=rag_result.context_source,
            hits_count=len(rag_result.hits),
            document_count=rag_result.document_count,
            preview_count=rag_result.preview_count,
            chunk_ids=rag_result.chunk_ids,
            condensed_context=condensed_rag,
        )
    
    # === 4ë‹¨ê³„: í•¨ìˆ˜ í˜¸ì¶œ ë¶„ì„/ì‹¤í–‰ ===
    func_results = await self._analyze_and_execute_functions(message)
    metadata.functions = func_results
    
    # === 5ë‹¨ê³„: ìµœì¢… ì»¨í…ìŠ¤íŠ¸ êµ¬ì„± ===
    final_context = self._build_final_context(
        message=message,
        condensed_rag=condensed_rag,
        func_results=func_results,
    )
    
    # === 6ë‹¨ê³„: ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ ìƒì„± ===
    completed_text = ""
    async for chunk in self._stream_openai_response(final_context):
        if chunk["type"] == "delta":
            yield json.dumps(chunk, ensure_ascii=False) + "\n"
        elif chunk["type"] == "completed":
            completed_text = chunk["text"]
    
    # === 7ë‹¨ê³„: ë©”íƒ€ë°ì´í„° ì „ì†¡ ===
    yield json.dumps({
        "type": "metadata",
        "data": metadata.to_dict()
    }, ensure_ascii=False) + "\n"
    
    # === 8ë‹¨ê³„: ì™„ë£Œ ì‹ í˜¸ ===
    yield json.dumps({"type": "done"}, ensure_ascii=False) + "\n"
    
    # === 9ë‹¨ê³„: ì‘ë‹µ ì €ì¥ ===
    self.add_response_stream(completed_text)
```

#### 2.3 í—¬í¼ ë©”ì„œë“œë“¤

```python
class ChatbotStream:
    # === ì–¸ì–´ë³„ ì§€ì¹¨ ===
    def _get_language_instruction(self, language: str) -> str:
        """ì–¸ì–´ ì½”ë“œì— ë”°ë¥¸ ì‘ë‹µ ì§€ì¹¨ ë°˜í™˜"""
        instruction_map = {
            "KOR": "í•œêµ­ì–´ë¡œ ì •ì¤‘í•˜ê³  ë”°ëœ»í•˜ê²Œ ë‹µí•´ì£¼ì„¸ìš”.",
            "ENG": "Please respond kindly in English.",
            "VI": "Vui lÃ²ng tráº£ lá»i báº±ng tiáº¿ng Viá»‡t má»™t cÃ¡ch nháº¹ nhÃ ng.",
            "JPN": "æ—¥æœ¬èªã§ä¸å¯§ã«æ¸©ã‹ãç­”ãˆã¦ãã ã•ã„ã€‚",
            "CHN": "è¯·ç”¨ä¸­æ–‡äº²åˆ‡åœ°å›ç­”ã€‚",
            "UZB": "Iltimos, o'zbek tilida samimiy va hurmat bilan javob bering.",
            "MNG": "ĞœĞ¾Ğ½Ğ³Ğ¾Ğ» Ñ…ÑĞ»ÑÑÑ€ ÑĞµĞ»Ğ´ÑĞ³, Ğ´ÑƒĞ»Ğ°Ğ°Ñ…Ğ°Ğ½ Ñ…Ğ°Ñ€Ğ¸ÑƒĞ»Ğ½Ğ° ÑƒÑƒ.",
            "IDN": "Tolong jawab dengan ramah dan hangat dalam bahasa Indonesia."
        }
        return instruction_map.get(language, instruction_map["KOR"])
    
    # === RAG ì»¨í…ìŠ¤íŠ¸ ìš”ì•½ ===
    async def _condense_rag_context(
        self, 
        user_question: str, 
        raw_context: str
    ) -> str:
        """
        ê¸´ RAG ì»¨í…ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©ì ì§ˆë¬¸ì— ë§ê²Œ ìš”ì•½
        - í‘œ/ë²ˆí˜¸ì¡°í•­ì˜ ì „ì²´ ë§¥ë½ í¬í•¨ (ìµœì†Œ 15ì¤„)
        - ì£¼ì„(ì£¼) í¬í•¨
        - ì›ë¬¸ êµ¬ì¡° ìœ ì§€
        """
        # routes.pyì˜ condense_prompt ë¡œì§ ì´ë™
        # ...
        pass
    
    # === í•¨ìˆ˜ í˜¸ì¶œ ===
    async def _analyze_and_execute_functions(
        self, 
        message: str
    ) -> List[FunctionCallMetadata]:
        """
        í•¨ìˆ˜ í˜¸ì¶œ ë¶„ì„ ë° ì‹¤í–‰
        1) FunctionCalling.analyze()ë¡œ í•„ìš”í•œ í•¨ìˆ˜ íŒŒì•…
        2) ê° í•¨ìˆ˜ ì‹¤í–‰
        3) í•™ì‹ ë³´ê°• ë¡œì§ (í‚¤ì›Œë“œ ê¸°ë°˜ fallback)
        4) ê²°ê³¼ë¥¼ FunctionCallMetadata ë¦¬ìŠ¤íŠ¸ë¡œ ë°˜í™˜
        """
        # routes.pyì˜ í•¨ìˆ˜ í˜¸ì¶œ ë¡œì§ ì´ë™
        # ...
        pass
    
    # === ìµœì¢… ì»¨í…ìŠ¤íŠ¸ êµ¬ì„± ===
    def _build_final_context(
        self,
        message: str,
        condensed_rag: Optional[str],
        func_results: List[FunctionCallMetadata],
    ) -> List[Dict[str, str]]:
        """
        ìµœì¢… LLM ì…ë ¥ ì»¨í…ìŠ¤íŠ¸ êµ¬ì„±
        - ì‚¬ìš©ì ì¿¼ë¦¬ ì§€ì¹¨
        - ì¼ë°˜ ì§€ì¹¨
        - ê¸°ì–µê²€ìƒ‰ ì§€ì¹¨ + ë‚´ìš©
        - ì›¹ê²€ìƒ‰ ì§€ì¹¨ + ê²°ê³¼
        - í•¨ìˆ˜ê²°ê³¼ ì§€ì¹¨ + ë‚´ìš©
        - í†µí•© ì§€ì¹¨
        """
        # routes.pyì˜ sections êµ¬ì„± ë¡œì§ ì´ë™
        # ...
        pass
    
    # === OpenAI ìŠ¤íŠ¸ë¦¬ë° ===
    async def _stream_openai_response(
        self, 
        context: List[Dict[str, str]]
    ) -> AsyncGenerator[Dict[str, Any], None]:
        """
        OpenAI Responses API ìŠ¤íŠ¸ë¦¬ë° í˜¸ì¶œ
        - event.delta ë°œìƒ ì‹œ {"type": "delta", "content": ...} yield
        - response.completed ì‹œ {"type": "completed", "text": ...} yield
        """
        # routes.pyì˜ generate_with_tool() ë¡œì§ ì´ë™
        # ...
        pass
```

---

### 3. ì‘ë‹µ í¬ë§· (JSON Lines)

#### 3.1 ì‹¤ì‹œê°„ í…ìŠ¤íŠ¸ ì²­í¬

```json
{"type": "delta", "content": "ì•ˆë…•í•˜ì„¸ìš”"}
{"type": "delta", "content": " ì¡¸ì—…"}
{"type": "delta", "content": " ê·œì •ì—"}
{"type": "delta", "content": " ëŒ€í•´"}
```

#### 3.2 ë©”íƒ€ë°ì´í„° (ì‘ë‹µ ì™„ë£Œ í›„)

```json
{
  "type": "metadata",
  "data": {
    "rag": {
      "is_regulation": true,
      "gate_reason": "LLM íŒë‹¨: ì¡¸ì—… ê·œì • ê´€ë ¨ ì§ˆë¬¸",
      "context_source": "mongo",
      "hits_count": 5,
      "document_count": 3,
      "preview_count": 0,
      "chunk_ids": ["673abc123...", "673def456..."],
      "has_condensed_context": true
    },
    "functions": [
      {
        "name": "search_internet",
        "arguments": {"query": "í•œë¼ëŒ€ ì¡¸ì—… ìš”ê±´"},
        "output": "ê²€ìƒ‰ ê²°ê³¼: ...",
        "call_id": "call_123",
        "is_fallback": false
      }
    ],
    "web_search_status": "ok"
  }
}
```

#### 3.3 ì™„ë£Œ ì‹ í˜¸

```json
{"type": "done"}
```

---

### 4. routes.py ë¦¬íŒ©í„°ë§ í›„ ì½”ë“œ

#### 4.1 ì „ì²´ ì½”ë“œ (10ì¤„ ë¯¸ë§Œ)

```python
from fastapi import APIRouter, HTTPException 
from fastapi.responses import StreamingResponse
from pydantic import BaseModel
from app.chatbotDirectory.chatbot import ChatbotStream
from app.chatbotDirectory.common import model

router = APIRouter()

# ì±—ë´‡ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
chatbot = ChatbotStream(
    model=model.advanced,
    system_role="""ë‹¹ì‹ ì€ í•™êµ ìƒí™œ, í•™ê³¼ ì •ë³´, í–‰ì‚¬ ë“± ì‚¬ìš©ìê°€ ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ë©´ ì•„ëŠ” ë²”ìœ„ ì•ˆì—ì„œ ëŒ€ë‹µí•©ë‹ˆë‹¤. ë‹¨ ì ˆëŒ€ ê±°ì§“ë‚´ìš©ì„ ë§í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì•„ëŠ” ë²”ìœ„ì—ì„œ ë§í•˜ê³  ë¶€ì¡±í•œ ë¶€ë¶„ì€ ì¸ì •í•˜ì„¸ìš”.
    ë‹¹ì‹ ì€ ì‹¤ì‹œê°„ìœ¼ë¡œ ê²€ìƒ‰í•˜ëŠ” ê¸°ëŠ¥ì´ìˆìŠµë‹ˆë‹¤.
    ë‹¹ì‹ ì€ í•œë¼ëŒ€ ê³µì§€ì‚¬í•­ì„ íƒìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    ë‹¹ì‹ ì€ í•œë¼ëŒ€ í•™ì‹ë©”ë‰´ë¥¼ íƒìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    ë‹¹ì‹ ì€ í•œë¼ëŒ€ í•™ì‚¬ì¼ì •ì„ íƒìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.""",
    instruction="ë‹¹ì‹ ì€ ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ë‹µë³€í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.",
)

class UserRequest(BaseModel):
    message: str
    language: str = "KOR"

@router.post("/chat")
async def stream_chat(user_input: UserRequest):
    """
    ì±—ë´‡ ìŠ¤íŠ¸ë¦¬ë° ì—”ë“œí¬ì¸íŠ¸
    
    Request Body:
        {
            "message": "ì¡¸ì—… ê·œì •ì„ ì•Œë ¤ì£¼ì„¸ìš”",
            "language": "KOR"
        }
    
    Response (JSON Lines):
        {"type": "delta", "content": "ì•ˆë…•í•˜ì„¸ìš”"}
        {"type": "delta", "content": " ì¡¸ì—…"}
        {"type": "metadata", "data": {...}}
        {"type": "done"}
    """
    return StreamingResponse(
        chatbot.stream_chat(
            message=user_input.message,
            language=user_input.language
        ),
        media_type="application/x-ndjson"
    )
```

#### 4.2 FunctionCalling ì´ˆê¸°í™”ëŠ” ì–´ë””ì„œ?

**ì˜µì…˜ A: ChatbotStream ë‚´ë¶€ë¡œ ì´ë™ (ì¶”ì²œ)**

```python
class ChatbotStream:
    def __init__(self, model, system_role, instruction, **kwargs):
        # ... ê¸°ì¡´ ì´ˆê¸°í™” ...
        
        # FunctionCalling ë‚´ë¶€ ì´ˆê¸°í™”
        from .functioncalling import FunctionCalling, tools
        self.func_calling = FunctionCalling(
            model=model,
            available_functions={
                # í•„ìš”í•œ í•¨ìˆ˜ë“¤ ë“±ë¡
            }
        )
        self.tools = tools
```

**ì˜µì…˜ B: ì˜ì¡´ì„± ì£¼ì… (ë” ìœ ì—°)**

```python
# routes.py
from app.chatbotDirectory.functioncalling import FunctionCalling, tools

func_calling = FunctionCalling(model=model.basic, available_functions={...})

chatbot = ChatbotStream(
    model=model.advanced,
    system_role="...",
    instruction="...",
    func_calling=func_calling,  # ì£¼ì…
    tools=tools,
)
```

---

## ğŸ”„ ë§ˆì´ê·¸ë ˆì´ì…˜ ë‹¨ê³„

### Phase 0: íŒŒì¼ êµ¬ì¡° ì¬êµ¬ì„± (ì‹ ê·œ)
- [ ] `ai/` ë””ë ‰í† ë¦¬ ìƒì„±
- [ ] `chatbotDirectory/` â†’ `ai/chatbot/` ì´ë™ ë° íŒŒì¼ ë¶„ë¦¬
  - [ ] `chatbot.py` â†’ `stream.py` ì´ë¦„ ë³€ê²½
  - [ ] `common.py` â†’ `config.py` ì´ë¦„ ë³€ê²½
  - [ ] ë©”íƒ€ë°ì´í„° í´ë˜ìŠ¤ë¥¼ `metadata.py`ë¡œ ë¶„ë¦¬
- [ ] `functioncalling.py` â†’ `ai/functions/` ëª¨ë“ˆí™”
  - [ ] `FunctionCalling` â†’ `analyzer.py`
  - [ ] ê° í•¨ìˆ˜ë³„ íŒŒì¼ ë¶„ë¦¬ (`web_search.py`, `cafeteria.py` ë“±)
  - [ ] `tools` ì •ì˜ â†’ `tools.py`
- [ ] `loding/` â†’ `ai/data/` ì´ë™ ë° ì´ë¦„ ìˆ˜ì •
  - [ ] `documentLoding.py` â†’ `document_loader.py`
  - [ ] `mongodbConnect.py` â†’ `mongodb_client.py`
  - [ ] `vector_db_upload.py` â†’ `vector_uploader.py`
- [ ] `rag/` â†’ `ai/rag/` ì´ë™
- [ ] í…ŒìŠ¤íŠ¸ íŒŒì¼ í†µí•©
  - [ ] `tests/` ë””ë ‰í† ë¦¬ ìƒì„±
  - [ ] `test.py` â†’ `tests/test_chatbot.py`
  - [ ] `test_stream_chat.py` â†’ `tests/test_stream_chat.py`
- [ ] ëª¨ë“  import ê²½ë¡œ ì—…ë°ì´íŠ¸ (`app.ai.*` í˜•ì‹ìœ¼ë¡œ)

### Phase 1: ì¤€ë¹„ ë‹¨ê³„
- [ ] `RagMetadata`, `FunctionCallMetadata`, `ChatMetadata` í´ë˜ìŠ¤ ì •ì˜ (`ai/chatbot/metadata.py`)
- [ ] `ai/chatbot/stream.py`ì— í—¬í¼ ë©”ì„œë“œ ìŠ¤í… ì‘ì„±

### Phase 2: í—¬í¼ ë©”ì„œë“œ êµ¬í˜„ (routes.py â†’ stream.py)

> **ëª©í‘œ**: routes.pyì˜ ë³µì¡í•œ ë¡œì§ì„ ChatbotStreamì˜ private ë©”ì„œë“œë¡œ ì´ë™

#### 2.1 ì¤€ë¹„ ì‘ì—…
- [ ] `ai/chatbot/stream.py` í˜„ì¬ ìƒíƒœ í™•ì¸
- [ ] `api/routes.py`ì—ì„œ ì´ë™í•  ë¡œì§ íŒŒì•…
- [ ] í•„ìš”í•œ import ì¶”ê°€

#### 2.2 ì–¸ì–´ ì§€ì¹¨ ë©”ì„œë“œ (`_get_language_instruction`)
- [ ] routes.pyì—ì„œ `instruction_map` ë¡œì§ ë³µì‚¬
- [ ] `_get_language_instruction(language: str) -> str` ë©”ì„œë“œ êµ¬í˜„
- [ ] 8ê°œ ì–¸ì–´ ì§€ì› (KOR, ENG, VI, JPN, CHN, UZB, MNG, IDN)
- [ ] ê¸°ë³¸ê°’: KOR

**ì½”ë“œ ìœ„ì¹˜**: routes.py ì•½ 150-160ì¤„

#### 2.3 í•¨ìˆ˜ í˜¸ì¶œ ë©”ì„œë“œ (`_analyze_and_execute_functions`)
- [ ] routes.pyì—ì„œ í•¨ìˆ˜ í˜¸ì¶œ ì„¹ì…˜ ì „ì²´ ë³µì‚¬ (ì•½ 120ì¤„)
- [ ] `async def _analyze_and_execute_functions(message: str) -> List[FunctionCallMetadata]` ì‹œê·¸ë‹ˆì²˜ ìœ ì§€
- [ ] FunctionCalling.analyze() ê²°ê³¼ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ í•¨ìˆ˜ ì‹¤í–‰
- [ ] ì‹¤íŒ¨/ë¯¸ë“±ë¡ í•¨ìˆ˜ ëŒ€ë¹„ ì˜ˆì™¸ ì²˜ë¦¬ ë° ë¡œê¹… ì¶”ê°€
- [ ] í•™ì‹ í‚¤ì›Œë“œ ê¸°ë°˜ fallback í˜¸ì¶œ(ê·œì¹™ ê¸°ë°˜) í¬í•¨
- [ ] ì‹¤í–‰ ê²°ê³¼ë¥¼ `FunctionCallMetadata` ëª©ë¡ìœ¼ë¡œ ì§ë ¬í™”í•˜ì—¬ ë°˜í™˜

**ì½”ë“œ ìœ„ì¹˜**: routes.py ì•½ 260-380ì¤„

**ì„¸ë¶€ ë‹¨ê³„**
1. **í•¨ìˆ˜ ë¶„ì„ í˜¸ì¶œ**: `self.func_calling.analyze(message, self.tools)`ë¡œ tool í˜¸ì¶œ ê³„íšì„ ë°›ì•„ì˜µë‹ˆë‹¤. ê²°ê³¼ ê°ì²´ê°€ `function_call` íƒ€ì…ì¸ì§€ í™•ì¸ í›„ë§Œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
2. **ì¸ì íŒŒì‹± & ìœ íš¨ì„± ê²€ì‚¬**: `json.loads(tool_call.arguments)`ë¡œ íŒŒì‹±í•˜ë˜ ì‹¤íŒ¨ ì‹œ ê±´ë„ˆë›°ê³  ë””ë²„ê·¸ ë¡œê·¸ ë‚¨ê¹ë‹ˆë‹¤. `dict`ê°€ ì•„ë‹ ê²½ìš° ë¬´ì‹œí•©ë‹ˆë‹¤.
3. **í•¨ìˆ˜ ì‹¤í–‰**: `self.available_functions`ì—ì„œ í•¨ìˆ˜ ë ˆí¼ëŸ°ìŠ¤ë¥¼ ì°¾ê³ , 
   - `search_internet`ëŠ” `chat_context=self.context[:]` ì¸ìë¥¼ ì¶”ê°€ ì£¼ì…
   - `get_halla_cafeteria_menu`ëŠ” `date`, `meal` ê¸°ë³¸ê°’ ë³´ê°•
   - ì‹¤í–‰ ë„ì¤‘ ì˜ˆì™¸ ë°œìƒ ì‹œ ë©”íƒ€ë°ì´í„°ì— ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ê¸°ë¡í•˜ê³  ë‹¤ìŒ í˜¸ì¶œë¡œ ì§„í–‰
4. **ë©”íƒ€ë°ì´í„° ëˆ„ì **: ê° í˜¸ì¶œì— ëŒ€í•´ `FunctionCallMetadata` ìƒì„±
   - `name`, `arguments`, `output`, `call_id`, `is_fallback=False`
   - ì¶œë ¥ì´ ë„ˆë¬´ ê¸¸ ê²½ìš° 2~3ì¤„ë¡œ ìë¥´ê³  ì›ë³¸ì€ ë¡œê·¸ì—ë§Œ ë‚¨ê¹€
5. **í•™ì‹ ë³´ê°• Fallback**: LLMì´ í˜¸ì¶œí•˜ì§€ ì•Šì•„ë„ "í•™ì‹", "ì‹ë‹¨", "ë©”ë‰´" ë“±ì˜ í‚¤ì›Œë“œê°€ í¬í•¨ë˜ë©´ fallback ì‹¤í–‰
   - ë‚ ì§œ/ë¼ë‹ˆ ì¶”ì¶œ (`ì •ê·œì‹`, `meal_pref`)
   - ì„±ê³µ ì‹œ `call_id="cafeteria_auto"`, `is_fallback=True`ë¡œ ë©”íƒ€ë°ì´í„° ì¶”ê°€
   - ì‹¤íŒ¨ ì‹œ ê²½ê³  ë¡œê·¸ ì¶œë ¥
6. **ì›¹ê²€ìƒ‰ ìƒíƒœ ê°±ì‹ **: ë°˜í™˜ ì˜ˆì • `ChatMetadata`ì—ì„œ `web_search_status` ë³€ê²½ì„ ìœ„í•´ ê²€ìƒ‰ í•¨ìˆ˜ í˜¸ì¶œ ì—¬ë¶€ë¥¼ booleanìœ¼ë¡œ ê¸°ë¡í•©ë‹ˆë‹¤.
7. **ë°˜í™˜ê°’**: `List[FunctionCallMetadata]`ì™€ í•™ì‹ fallback ê²°ê³¼, ì›¹ê²€ìƒ‰ ìƒíƒœë¥¼ í•¨ê»˜ ë¦¬í„´í•˜ê±°ë‚˜ ìƒìœ„ ë©”ì„œë“œê°€ ì°¸ì¡°í•  ìˆ˜ ìˆë„ë¡ ì†ì„±ì— ì €ì¥í•©ë‹ˆë‹¤.

**ì˜ì‚¬ ì½”ë“œ**
```python
func_results: List[FunctionCallMetadata] = []
web_search_used = False

for tool_call in self.func_calling.analyze(message, self.tools):
    if getattr(tool_call, "type", None) != "function_call":
        continue

    func_name = tool_call.name
    func_args = self._safe_parse_arguments(tool_call.arguments)
    if func_args is None:
        continue

    func = self.available_functions.get(func_name)
    if not func:
        self._dbg(f"[FUNCTION] ë¯¸ë“±ë¡ í•¨ìˆ˜: {func_name}")
        continue

    try:
        if func_name == "search_internet":
            func_args.setdefault("chat_context", self.context[:])
        elif func_name == "get_halla_cafeteria_menu":
            func_args.setdefault("date", "ì˜¤ëŠ˜")

        output = func(**func_args)
        if func_name == "search_internet":
            web_search_used = True

        func_results.append(FunctionCallMetadata(
            name=func_name,
            arguments=func_args,
            output=str(output),
            call_id=getattr(tool_call, "call_id", "call_unknown"),
        ))
    except Exception as exc:
        self._dbg(f"[FUNCTION] {func_name} ì‹¤í–‰ ì‹¤íŒ¨: {exc}")

# ê·œì¹™ ê¸°ë°˜ í•™ì‹ fallback
if self._needs_cafeteria_fallback(message, func_results):
    fallback_meta = self._run_cafeteria_fallback(message)
    if fallback_meta:
        func_results.append(fallback_meta)

return func_results, web_search_used
```

**ê²€ì¦ í¬ì¸íŠ¸**
- í•¨ìˆ˜ í˜¸ì¶œ ì‹¤íŒ¨ê°€ ìŠ¤íŠ¸ë¦¼ ì „ì²´ë¥¼ ì¤‘ë‹¨ì‹œí‚¤ì§€ ì•Šì•„ì•¼ í•¨ (try/except).
- `FunctionCallMetadata`ì˜ `arguments`ëŠ” JSON ì§ë ¬í™” ê°€ëŠ¥í•œ dictë¡œ ìœ ì§€.
- fallback í˜¸ì¶œ ì‹œ `is_fallback=True`, `call_id="cafeteria_auto"` ë“± ë©”íƒ€ë°ì´í„° ê·œì¹™ ì¤€ìˆ˜.
- `search_internet`ë¥¼ ìˆ˜í–‰í•œ ê²½ìš° ìƒìœ„ì—ì„œ `metadata.web_search_status="ok"`ë¡œ í‘œì‹œí•  ìˆ˜ ìˆë„ë¡ ìƒíƒœê°’ ë°˜í™˜.

#### 2.4 RAG ì»¨í…ìŠ¤íŠ¸ ìš”ì•½ ë©”ì„œë“œ (`_condense_rag_context`)
- [ ] routes.pyì—ì„œ `condense_prompt` ë¡œì§ ë³µì‚¬
- [ ] `async def _condense_rag_context(user_question: str, raw_context: str) -> str` êµ¬í˜„
- [ ] OpenAI API í˜¸ì¶œ (model.basic ì‚¬ìš©)
- [ ] ì—ëŸ¬ ì²˜ë¦¬ (ìš”ì•½ ì‹¤íŒ¨ ì‹œ ì›ë³¸ ë°˜í™˜)

**ì½”ë“œ ìœ„ì¹˜**: routes.py ì•½ 190-250ì¤„ (60ì¤„)

**í•µì‹¬ ë¡œì§**:
```python
# ìš”ì•½ í”„ë¡¬í”„íŠ¸ êµ¬ì„±
condense_prompt = [
    {"role": "system", "content": "ë‹¹ì‹ ì€ ê·œì • ë¬¸ì„œ ìš”ì•½ ì „ë¬¸ê°€ì…ë‹ˆë‹¤..."},
    {"role": "user", "content": f"ì§ˆë¬¸: {user_question}\n\në¬¸ì„œ:\n{raw_context}"}
]

# OpenAI í˜¸ì¶œ
response = client.responses.create(
    model=model.basic,
    messages=condense_prompt,
    max_completion_tokens=1500
)
return response.output.choices[0].message.content
```

#### 2.5 ìµœì¢… ì»¨í…ìŠ¤íŠ¸ êµ¬ì„± ë©”ì„œë“œ (`_build_final_context`)
- [ ] routes.pyì—ì„œ `sections` êµ¬ì„± ë¡œì§ ë³µì‚¬ (ì•½ 160ì¤„)
- [ ] `def _build_final_context(message, condensed_rag, func_results) -> List[Dict[str, str]]` êµ¬í˜„
- [ ] 7ê°€ì§€ ì„¹ì…˜ ì¡°ë¦½:
  1. ì‚¬ìš©ìì¿¼ë¦¬ì§€ì¹¨
  2. ì¼ë°˜ì§€ì¹¨
  3. ê¸°ì–µê²€ìƒ‰ì§€ì¹¨ + ë‚´ìš©
  4. ì›¹ê²€ìƒ‰ì§€ì¹¨ + ê²°ê³¼
  5. í•¨ìˆ˜ê²°ê³¼ì§€ì¹¨ + ë‚´ìš©
  6. í†µí•©ì§€ì¹¨
  7. ìµœì¢… ì‹œìŠ¤í…œ ë©”ì‹œì§€
- [ ] temp_context ë°˜í™˜

**ì½”ë“œ ìœ„ì¹˜**: routes.py ì•½ 390-550ì¤„

**í•µì‹¬ êµ¬ì¡°**:
```python
sections = []
temp_context = list(self.context)  # ê¸°ì¡´ ëŒ€í™” ë³µì‚¬

# 1. ì‚¬ìš©ìì¿¼ë¦¬ì§€ì¹¨
sections.append("[ì‚¬ìš©ìì¿¼ë¦¬ì§€ì¹¨]\n...")

# 2. ì¼ë°˜ì§€ì¹¨
sections.append("[ì¼ë°˜ì§€ì¹¨]\n...")

# 3. ê¸°ì–µê²€ìƒ‰ì§€ì¹¨ (RAG)
if condensed_rag:
    sections.append(f"[ê¸°ì–µê²€ìƒ‰ì§€ì¹¨]\n{condensed_rag}")

# 4. ì›¹ê²€ìƒ‰ì§€ì¹¨
web_search_func = next((f for f in func_results if f.name == "search_internet"), None)
if web_search_func:
    sections.append(f"[ì›¹ê²€ìƒ‰ì§€ì¹¨]\n{web_search_func.output}")

# 5. í•¨ìˆ˜ê²°ê³¼ì§€ì¹¨ (í•™ì‹, ê³µì§€ì‚¬í•­ ë“±)
# ...

# 6. í†µí•©ì§€ì¹¨
sections.append("[í†µí•©ì§€ì¹¨]\n...")

# ìµœì¢… ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì¶”ê°€
temp_context.append({
    "role": "system",
    "content": "\n\n".join(sections)
})

return temp_context
```

#### 2.6 OpenAI ìŠ¤íŠ¸ë¦¬ë° ë©”ì„œë“œ (`_stream_openai_response`)
- [ ] routes.pyì—ì„œ `generate_with_tool()` ë¡œì§ ë³µì‚¬ (ì•½ 60ì¤„)
- [ ] `async def _stream_openai_response(context) -> AsyncGenerator[Dict, None]` êµ¬í˜„
- [ ] OpenAI Responses API ìŠ¤íŠ¸ë¦¬ë° í˜¸ì¶œ
- [ ] delta ì´ë²¤íŠ¸ ì²˜ë¦¬
- [ ] completed ì´ë²¤íŠ¸ ì²˜ë¦¬
- [ ] ì—ëŸ¬ ì²˜ë¦¬

**ì½”ë“œ ìœ„ì¹˜**: routes.py ì•½ 560-620ì¤„

**í•µì‹¬ ë¡œì§**:
```python
stream = client.responses.create(
    model=self.model,
    messages=context,
    stream=True
)

completed_text = ""
for event in stream:
    if event.type == "response.delta":
        yield {
            "type": "delta",
            "content": event.delta
        }
        completed_text += event.delta
    elif event.type == "response.completed":
        yield {
            "type": "completed",
            "text": completed_text
        }
```

#### 2.7 ê²€ì¦
- [ ] ê° í—¬í¼ ë©”ì„œë“œì— íƒ€ì… íŒíŠ¸ ì¶”ê°€
- [ ] Docstring ì‘ì„± (í•œêµ­ì–´)
- [ ] routes.pyì™€ ë™ì¼í•œ ë™ì‘ í™•ì¸
- [ ] import ì—ëŸ¬ ì—†ëŠ”ì§€ í™•ì¸

### Phase 3: í†µí•© ë©”ì„œë“œ ì‘ì„±
- [ ] `stream_chat()` ë©”ì„œë“œ êµ¬í˜„ (ëª¨ë“  í—¬í¼ ì¡°í•©)
- [ ] JSON Lines ì‘ë‹µ í¬ë§· êµ¬í˜„
- [ ] ë©”íƒ€ë°ì´í„° ì „ì†¡ ë¡œì§ ì¶”ê°€

### Phase 4: routes.py ë¦¬íŒ©í„°ë§
- [ ] ê¸°ì¡´ `/chat` ì—”ë“œí¬ì¸íŠ¸ë¥¼ `chatbot.stream_chat()` í˜¸ì¶œë¡œ ë‹¨ìˆœí™”
- [ ] ë¶ˆí•„ìš”í•œ import ì œê±°
- [ ] FunctionCalling ì´ˆê¸°í™” ìœ„ì¹˜ ê²°ì • (ChatbotStream ë‚´ë¶€ vs ì˜ì¡´ì„± ì£¼ì…)

### Phase 5: í…ŒìŠ¤íŠ¸ ë° ê²€ì¦
- [ ] ì¼ë°˜ ì§ˆë¬¸ í…ŒìŠ¤íŠ¸
- [ ] RAG ì§ˆë¬¸ í…ŒìŠ¤íŠ¸ (ì¡¸ì—… ê·œì •)
- [ ] í•¨ìˆ˜ í˜¸ì¶œ í…ŒìŠ¤íŠ¸ (í•™ì‹ ë©”ë‰´)
- [ ] ë³µí•© ì§ˆë¬¸ í…ŒìŠ¤íŠ¸ (RAG + ì›¹ê²€ìƒ‰)
- [ ] ë©”íƒ€ë°ì´í„° ì‘ë‹µ í™•ì¸
- [ ] ìŠ¤íŠ¸ë¦¬ë° ë™ì‘ í™•ì¸

### Phase 6: ë¬¸ì„œí™”
- [ ] `stream_chat()` API ë¬¸ì„œ ì‘ì„±
- [ ] ë©”íƒ€ë°ì´í„° êµ¬ì¡° ë¬¸ì„œí™”
- [ ] í”„ë¡ íŠ¸ì—”ë“œ í†µí•© ê°€ì´ë“œ ì‘ì„±
- [ ] ìƒˆ íŒŒì¼ êµ¬ì¡° README ì—…ë°ì´íŠ¸

---

## ğŸ“Š ì˜ˆìƒ íš¨ê³¼

### Before (í˜„ì¬)
- routes.py: **440ì¤„** (ë³µì¡í•œ ì±—ë´‡ ë¡œì§ í¬í•¨)
- chatbot.py: **422ì¤„** (ê¸°ë³¸ ìŠ¤íŠ¸ë¦¬ë°ë§Œ)
- **ê²°í•©ë„**: ë†’ìŒ (ë¼ìš°í„°ê°€ ì±—ë´‡ ë‚´ë¶€ ë¡œì§ ì•Œì•„ì•¼ í•¨)
- **ì¬ì‚¬ìš©ì„±**: ë‚®ìŒ (ì½”ë“œ ì¤‘ë³µ í•„ìš”)
- **í…ŒìŠ¤íŠ¸**: ì–´ë ¤ì›€ (ë¼ìš°í„° ë ˆë²¨ì—ì„œë§Œ ê°€ëŠ¥)

### After (ëª©í‘œ)
- routes.py: **~30ì¤„** (ë‹¨ìˆœ ìš”ì²­/ì‘ë‹µ ì²˜ë¦¬)
- chatbot.py: **~800ì¤„** (ëª¨ë“  ì±—ë´‡ ë¡œì§ í¬í•¨)
- **ê²°í•©ë„**: ë‚®ìŒ (ë¼ìš°í„°ëŠ” ì±—ë´‡ ì¸í„°í˜ì´ìŠ¤ë§Œ ì•Œë©´ ë¨)
- **ì¬ì‚¬ìš©ì„±**: ë†’ìŒ (ë‹¤ë¥¸ ì—”ë“œí¬ì¸íŠ¸ì—ì„œë„ ì‚¬ìš© ê°€ëŠ¥)
- **í…ŒìŠ¤íŠ¸**: ì‰¬ì›€ (ChatbotStream ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥)

---

## ğŸš¨ ì£¼ì˜ì‚¬í•­

### 1. ë¹„ë™ê¸° ì²˜ë¦¬
- `stream_chat()`ì€ `async def`ë¡œ ì •ì˜
- OpenAI API í˜¸ì¶œ ì‹œ `await` ì‚¬ìš©
- `AsyncGenerator` ë°˜í™˜ íƒ€ì… ëª…ì‹œ

### 2. ì—ëŸ¬ ì²˜ë¦¬
- RAG ì‹¤íŒ¨ ì‹œ fallback ë¡œì§
- í•¨ìˆ˜ í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ graceful degradation
- ìŠ¤íŠ¸ë¦¬ë° ì¤‘ ì—ëŸ¬ ë°œìƒ ì‹œ í´ë¼ì´ì–¸íŠ¸ì— ì•Œë¦¼

### 3. ì„±ëŠ¥ ê³ ë ¤
- ê¸´ ë¬¸ì„œ ìš”ì•½ ì‹œ í† í° ì œí•œ ì£¼ì˜
- ë©”íƒ€ë°ì´í„° í¬ê¸° ì œí•œ (ë„ˆë¬´ í¬ë©´ ì••ì¶•/ì¶•ì•½)
- ë™ì‹œ ìš”ì²­ ì²˜ë¦¬ (FastAPIì˜ ë¹„ë™ê¸° ì¥ì  í™œìš©)

### 4. í•˜ìœ„ í˜¸í™˜ì„±
- ê¸°ì¡´ API ì‘ë‹µ í¬ë§· ìœ ì§€ (ë˜ëŠ” ë²„ì „ ë¶„ë¦¬)
- ë©”íƒ€ë°ì´í„°ëŠ” ì„ íƒì ìœ¼ë¡œ ë°˜í™˜ (í´ë¼ì´ì–¸íŠ¸ê°€ ìš”ì²­í•œ ê²½ìš°ë§Œ)

---

## ğŸ“ ë‹¤ìŒ ë‹¨ê³„

1. **ë°ì´í„° í´ë˜ìŠ¤ ì •ì˜** (`RagMetadata`, `FunctionCallMetadata`, `ChatMetadata`)
2. **í—¬í¼ ë©”ì„œë“œ êµ¬í˜„** (ì–¸ì–´ ì§€ì¹¨, RAG ìš”ì•½, í•¨ìˆ˜ í˜¸ì¶œ, ì»¨í…ìŠ¤íŠ¸ êµ¬ì„±, ìŠ¤íŠ¸ë¦¬ë°)
3. **`stream_chat()` ë©”ì„œë“œ í†µí•©**
4. **routes.py ë‹¨ìˆœí™”**
5. **í…ŒìŠ¤íŠ¸ ë° ê²€ì¦**

---

## ì°¸ê³  ìë£Œ

- [RAG ë¶„ë¦¬ ê³„íš (Phase 2)](./RAG_ë¶„ë¦¬_ê³„íš.md)
- [í”„ë¡ íŠ¸ì—”ë“œ ìŠ¤íŠ¸ë¦¬ë° ê°€ì´ë“œ (í•„ë…!)](./í”„ë¡ íŠ¸ì—”ë“œ_ìŠ¤íŠ¸ë¦¬ë°_ê°€ì´ë“œ.md) â­
- [OpenAI Responses API Streaming](https://platform.openai.com/docs/api-reference/streaming)
- [FastAPI StreamingResponse](https://fastapi.tiangolo.com/advanced/custom-response/#streamingresponse)
- [JSON Lines Format](https://jsonlines.org/)
