# 한라챗봇 데이터 흐름도

이 문서는 한라챗봇 프로젝트의 데이터 흐름을 자세히 설명합니다.

## 1. 문서 처리 파이프라인

```
[학사 규정 PDF/HWP 파일]
        ↓
[documentLoding.py - 문서 로드 및 청킹]
        ↓
[문서 청크 + 메타데이터]
        ↓
        ↓─────────────┐
        │             │
        ↓             ↓
[MongoDB 저장]    [임베딩 생성]
(ai/data/         (ai/data/
mongodb_client.py) vector_uploader.py)
        │             │
        │             ↓
        │      [Pinecone 벡터 DB 저장]
        │             │
        └─────────────┘
                ↓
          [RAG 시스템]
          (ai/rag/)
```

## 2. 사용자 질문 처리 흐름

```
[사용자 질문]
      ↓
[API routes.py - /api/stream-chat]
      ↓
[ChatbotStream.stream_chat]
(ai/chatbot/stream.py)
      ↓
┌─────┴─────────────┐
↓                   ↓
[RAG 처리]      [함수 호출 분석]
(RagService)    (FunctionCalling)
ai/rag/         ai/functions/
service.py      analyzer.py
↓                   ↓
↓             ┌─────┴────────┐
↓             ↓              ↓
↓         [웹 검색]     [학식 메뉴 조회]
↓             ↓              ↓
↓             └──────────────┘
↓                   ↓
[규정 판단]    [함수 결과]
(RegulationGate)     ↓
↓                   ↓
[벡터 검색]          ↓
(PineconeRetriever)  ↓
↓                   ↓
[MongoDB 문서 조회]   ↓
(MongoChunkRepository)↓
↓                   ↓
[컨텍스트 조립]      ↓
(ContextBuilder)     ↓
↓                   ↓
[문서 압축/요약]      ↓
(_condense_rag_context)
↓                   ↓
└───────┬───────────┘
        ↓
[통합 컨텍스트 구성]
        ↓
[GPT 모델 응답 생성]
        ↓
[스트리밍 응답 전달]
```

## 3. RAG 처리 흐름

```
[사용자 질문]
      ↓
[RagService.retrieve_context]
(ai/rag/service.py)
      ↓
[규정 관련성 판단]
(RegulationGate.decide)
ai/rag/gate.py
      ↓
[임베딩 생성]
(get_embedding)
ai/data/vector_uploader.py
      ↓
[Pinecone 벡터 검색]
(PineconeRetriever.search)
ai/rag/retriever.py
      ↓
[MongoDB에서 문서 조회]
(MongoChunkRepository.fetch_chunks)
ai/rag/repository.py
      ↓
[문서 조합]
(ContextBuilder.build)
ai/rag/RagDocumentPackage.py
      ↓
[RagResult 반환]
      ↓
[LLM 기반 압축/요약]
(ChatbotStream._condense_rag_context)
      ↓
[GPT 컨텍스트에 통합]
```

## 4. 함수 호출 처리 흐름

```
[사용자 질문]
      ↓
[ChatbotStream._analyze_and_execute_functions]
(ai/chatbot/stream.py)
      ↓
[함수 필요성 분석]
(FunctionCalling.analyze)
ai/functions/analyzer.py
      ↓
┌─────┴─────┐
↓           ↓
[웹 검색]   [학식 메뉴 조회]
search_     get_halla_
internet    cafeteria_menu
↓           ↓
[결과 포맷팅]
      ↓
[함수 결과 반환]
      ↓
[GPT 컨텍스트에 통합]
```

## 5. 스트리밍 응답 생성 흐름

```
[통합된 컨텍스트]
      ↓
[OpenAI API 스트리밍 호출]
(client.responses.create stream=True)
ai/chatbot/config.py (client)
      ↓
┌─────┴──────────┐
↓                ↓
[이벤트 처리]    [응답 수집]
↓                ↓
[사용자에게 전송] [메시지 히스토리 추가]
(StreamingResponse)  (ChatbotStream.messages)
      ↓                ↓
[메타데이터 전송]    [컨텍스트 관리]
(RagMetadata,        (_manage_context_window)
 FunctionMetadata)
```

## 6. 데이터 저장소 구조

### 6.1 MongoDB

- **데이터베이스**: `halla_academic_db`
- **컬렉션**: `regulation_chunks`
- **문서 구조**:
  ```json
  {
    "_id": ObjectId,
    "text": "문서 내용",
    "metadata": {
      "law_article_id": "제00조",
      "title": "조항 제목",
      "source_file": "파일명.hwp",
      "category": "law_articles"
    }
  }
  ```

### 6.2 Pinecone 벡터 DB

- **인덱스**: `halla-academic-index`
- **네임스페이스**: `law_articles`, `appendix_tables`
- **벡터 구조**:
  ```json
  {
    "id": "uuid",
    "values": [임베딩 벡터],
    "metadata": {
      "mongo_id": "MongoDB ObjectId",
      "text_preview": "문서 미리보기",
      "source_file": "파일명.hwp"
    }
  }
  ```

## 7. 응답 컨텍스트 구조

```
[시스템 메시지]
- 일반 지침
- RAG 컨텍스트 (있는 경우)
- 함수 결과 (있는 경우)
- 통합 지침

[사용자 메시지]
- 사용자 질문
- 언어 지침

[어시스턴트 응답]
- 생성된 스트리밍 응답
```